Menu="Utilities"
Type="xmenu"
Title="Flash Backup Beta"
Icon="icon.png"
Tag="icon.png"
Markdown="false"
---
<?php
$cfgPath = '/boot/config/plugins/flash-backup_beta/settings.cfg';

// Define all default keys and their order
$defaults = [
    'MINIMAL_BACKUP' => 'no',
    'BACKUP_DESTINATION' => '',
    'BACKUPS_TO_KEEP' => '0',
    'BACKUP_OWNER' => 'nobody',
    'DRY_RUN' => 'no',
    'NOTIFICATIONS' => 'no',
    'DISCORD_WEBHOOK_URL' => '',
    'PUSHOVER_USER_KEY' => ''
];

// Load existing config if present
$existing = [];
if (file_exists($cfgPath)) {
    $existing = parse_ini_file($cfgPath) ?: [];
}
// Merge without overwriting existing keys
foreach ($defaults as $key => $value) {
    if (!array_key_exists($key, $existing)) {
        $existing[$key] = $value;
    }
}
// Rebuild config text in the correct order
$configText = '';
foreach ($defaults as $key => $defaultValue) {
    $val = $existing[$key];
    $configText .= "$key=\"$val\"\n";
}
@file_put_contents($cfgPath, $configText);
$settings = $existing;
?>

<?php
$remoteCfgPath = '/boot/config/plugins/flash-backup_beta/settings_remote.cfg';

// Define all default keys and their order for remote
$remoteDefaults = [
    'MINIMAL_BACKUP_REMOTE' => 'no',
    'RCLONE_CONFIG_REMOTE' => '',
    'B2_BUCKET_NAME' => '',
    'REMOTE_PATH_IN_CONFIG' => '/Flash_Backups',
    'BACKUPS_TO_KEEP_REMOTE' => '0',
    'DRY_RUN_REMOTE' => 'no',
    'NOTIFICATIONS_REMOTE' => 'no',
    'DISCORD_WEBHOOK_URL_REMOTE' => '',
    'PUSHOVER_USER_KEY_REMOTE' => ''
];

// Load existing remote config if present
$existingRemote = [];
if (file_exists($remoteCfgPath)) {
    $existingRemote = parse_ini_file($remoteCfgPath) ?: [];
}

// Merge defaults without overwriting existing keys
foreach ($remoteDefaults as $key => $value) {
    if (!array_key_exists($key, $existingRemote)) {
        $existingRemote[$key] = $value;
    }
}

// Rebuild remote config text in the correct order
$remoteConfigText = '';
foreach ($remoteDefaults as $key => $defaultValue) {
    $val = $existingRemote[$key];
    $remoteConfigText .= "$key=\"$val\"\n";
}

// Save the remote config
@file_put_contents($remoteCfgPath, $remoteConfigText);

// Make it available to your page
$remotesettings = $existingRemote;

// Load saved VM list (string or array)
$saved_vm_list = $vm_list_settings['VMS_TO_RESTORE'] ?? '';

// Normalize into array
if (!is_array($saved_vm_list)) {
    $saved_vm_list = array_filter(array_map('trim', explode(',', $saved_vm_list)));
}
?>

<?php
$unraid_version = "7.2"; // fallback
if (file_exists("/etc/unraid-version")) {
    $data = parse_ini_file("/etc/unraid-version");
    if (!empty($data["version"])) {
        $unraid_version = $data["version"];
    }
}
?>

<script>
  // UNIVERSAL CSRF TOKEN DISCOVERY for Unraid plugin pages
  let csrfToken = "<?= $_GET['csrf_token'] ?? ($_COOKIE['csrf_token'] ?? '') ?>";

  // Try dynamic lookup from global scope, cookie, or meta
  if (!csrfToken || csrfToken === "undefined" || csrfToken === "") {
    try {
      // Try the global variable used by Unraid's WebGUI JS
      if (typeof window.csrf_token !== "undefined" && window.csrf_token) {
        csrfToken = window.csrf_token;
      }

      // Try any embedded meta tag
      if ((!csrfToken || csrfToken === "") && document.querySelector("meta[name='csrf_token']")) {
        csrfToken = document.querySelector("meta[name='csrf_token']").getAttribute("content");
      }

      // Try cookie
      if ((!csrfToken || csrfToken === "") && document.cookie.includes("csrf_token=")) {
        const m = document.cookie.match(/csrf_token=([^;]+)/);
        if (m) csrfToken = decodeURIComponent(m[1]);
      }

      // Fallback: try to extract from any script tag in the parent frame
      if ((!csrfToken || csrfToken === "") && window.parent) {
        try {
          if (window.parent.csrf_token) csrfToken = window.parent.csrf_token;
        } catch (e) { /* ignore cross-frame */ }
      }
    } catch (err) {
      console.warn("CSRF token discovery failed:", err);
    }
  }
</script>

<style>
  :root {
    --primary-blue: #2ECC40;
  }

  .flash-backup_beta-wrapper {
    display: flex;
    flex-direction: column;
    width: 100%;
    min-width: 0;
  }

  /* === Each Panel (auto-sizing) === */
  #log-section {
    background: #111;
    border-radius: 12px;
    box-shadow: 0 0 12px rgba(46, 204, 64, .3);
    color: #f0f8ff;
    padding: 20px;
    flex: 1 1 auto;
    height: auto;
    max-height: none;
    overflow: visible;
    min-width: 0;
    width: 100%;
    box-sizing: border-box;
  }

  #log-section {
    max-height: 73vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    padding-top: 0;
  }

  #flash-backup_beta-settings-remote,
  #flash-backup_beta-settings {
    background: #111;
    border-radius: 12px;
    box-shadow: 0 0 12px rgba(46, 204, 64, .3);
    color: #f0f8ff;
    padding: 16px !important;
    flex: 1 1 auto;
    height: auto;
    max-height: none;
    overflow: visible;
    min-width: 0;
    width: 100%;
    box-sizing: border-box;
    flex-basis: 25%;
  }

  .unraid-71 #flash-backup_beta-settings {
    min-height: 77vh;
    max-height: 77vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-71 #log-section pre {
    max-height: 68vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-72 #flash-backup_beta-settings {
    min-height: 76vh;
    max-height: 76vh;
    overflow-y: auto;
    margin: 0;
  }

  .unraid-72 #log-section pre {
    max-height: 67vh;
    overflow-y: auto;
    margin: 0;
  }

  #flash-backup_beta-settings {
    flex: 1 1 100%;
  }

  label {
    color: var(--primary-blue);
    font-weight: bold;
    margin-bottom: 5px;
  }

  input,
  select {
    background: #111;
    border: 1px solid var(--primary-blue);
    border-radius: 5px;
    color: #fff;
    padding: 8px;
  }

  .unraid-71 .flash-backup_beta-wrapper {
    margin-top: -31px !important;
  }

  .unraid-72 .flash-backup_beta-wrapper {
    margin-top: -20px !important;
  }

  button {
    border: none;
    border-radius: 4px;
    color: #fff;
    cursor: pointer;
    margin-right: 10px;
    padding: 8px 15px;
  }

  input[type="checkbox"] {
    accent-color: var(--primary-blue);
    cursor: pointer;
    height: 16px;
    width: 16px;
  }

  .remote-status-row,
  .status-row {
    align-items: center;
    display: flex;
    margin-bottom: 6px;
  }

  .remote-status-label,
  .status-label {
    color: var(--primary-blue);
    font-weight: bold;
    width: 75px;
  }

  #version-text {
    color: #fff;
  }

  .form-pair {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 10px;
    margin-bottom: 15px;
    margin-top: 8px;
  }

  .input-wrapper {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .form-pair label {
    width: 130px;
    color: var(--primary-blue);
    font-weight: bold;
    text-align: left;
    margin-right: 10px;
  }

  .form-pair input,
  .form-pair select {
    background: #111;
    color: #fff;
    width: 200px;
    min-width: fit-content;
    max-width: 100%;
  }

  .form-pair input[type="text"],
  .form-pair input[type="password"] {
    min-width: fit-content;
    max-width: 100%;
  }

  .short-input {
    flex: 0 0 auto;
  }

  @keyframes shake {

    0%,
    100% {
      transform: translateX(0);
    }

    25% {
      transform: translateX(-5px);
    }

    50% {
      transform: translateX(5px);
    }

    75% {
      transform: translateX(-5px);
    }
  }

  #flash-backup_beta-settings.shake {
    animation: shake .3s;
  }

  .skipped-line {
    color: #ffd700;
  }

  #last-run-log {
    background: #111;
    border: 1px solid var(--primary-blue);
    border-radius: 8px;
    color: white;
    font-family: monospace;
    font-size: 13px;
    max-height: 66vh;
    overflow-y: auto;
    padding: 10px;
    white-space: pre-wrap;
    word-break: break-word;
    flex: 1;
    overflow-y: auto;
    margin-top: 0;
    min-height: 0;
  }

  input[type="number"].short-input {
    -moz-appearance: auto;
    -webkit-appearance: auto;
    appearance: auto;
  }

  input[type="number"] {
    padding-right: 0;
  }

  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    margin: 0;
    right: 0;
    position: absolute;
  }

  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }

  :focus-visible {
    outline: 2px solid var(--primary-blue);
    outline-offset: 2px;
  }

  button:hover,
  input[type="checkbox"]:hover,
  select:hover,
  a:hover {
    filter: brightness(1.1);
  }

  button:focus-visible,
  input[type="checkbox"]:focus-visible,
  select:focus-visible,
  a:focus-visible {
    outline: none;
    box-shadow: none
  }

  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-thumb {
    background: var(--primary-blue);
    border-radius: 4px;
  }

  .vm-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
  }

  .vm-modal-content {
    width: 600px;
    margin: 8% auto;
    background: #000;
    border: 2px solid #2ECC40;
    border-radius: 8px;
    color: #2ECC40;
    padding: 15px;
  }

  .vm-modal-header {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    margin-bottom: 10px;
  }

  .vm-folder-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #2ECC40;
    padding: 5px;
  }

  .vm-folder-item {
    padding: 6px;
    cursor: pointer;
  }

  .vm-folder-item:hover {
    background: #111;
  }

  .vm-folder-item label {
    cursor: pointer;
  }

  .vm-breadcrumb {
    margin-bottom: 10px;
    font-size: 13px;
    color: #2ECC40;
  }

  .vm-modal-footer {
    margin-top: 10px;
    text-align: right;
  }

  #folderPickerModal .vm-modal-header span {
    color: #ffffff;
  }

  #backup_destination {
    border: 1px solid #2ECC40 !important;
    background-color: #111 !important;
    color: #fff !important;
    padding-left: 6px;
    border-radius: 3px;
  }

  .log-header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 4px;
  }

  .log-header-row h3 {
    color: var(--primary-blue);
    font-size: 18px;
    margin: 0;
  }

  input.invalid {
    border-color: #2ECC40;
    color: red;
  }

  #flash-backup_beta-layout {
    display: grid;
    grid-template-columns: minmax(320px, 1fr) minmax(320px, 1fr) minmax(420px, 1.6fr);
    gap: 20px;
    width: 100%;
    margin-top: 0;
    padding-top: 0;
    align-items: stretch;

    --plugin-bg: #1e1e1e;
    --plugin-panel: #111;
    --plugin-border: #2ECC40;
    --plugin-text: #e6e6e6;
    --plugin-muted: #b0b0b0;
    --plugin-accent: #2ECC40;
  }

  #flash-backup_beta-layout select,
  #flash-backup_beta-layout input[type="text"],
  #flash-backup_beta-layout input[type="number"] {
    background-color: var(--plugin-panel);
    color: var(--plugin-text);
    border: 1px solid var(--plugin-border);
    border-radius: 6px;
    padding: 6px 8px;
  }

  #flash-backup_beta-layout label {
    color: var(--primary-blue);
  }

  #flash-backup_beta-layout input[type="checkbox"] {
    accent-color: var(--plugin-accent);
  }

  #flash-backup_beta-layout select option {
    background-color: var(--plugin-panel);
    color: var(--plugin-text);
  }

  #flash-backup_beta-layout select:hover,
  #flash-backup_beta-layout input:hover {
    border-color: var(--plugin-accent);
  }

  #flash-backup_beta-layout select option:hover,
  #flash-backup_beta-layout select option:focus {
    background-color: #e6231c;
    color: #ffffff;
  }

  #flash-backup_beta-layout select:disabled,
  #flash-backup_beta-layout input:disabled {
    background-color: #111;
    color: var(--plugin-muted);
    border-color: #2ECC40;
    cursor: not-allowed;
  }

  @media (max-width: 1200px) {
    #flash-backup_beta-layout {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 800px) {
    #flash-backup_beta-layout {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 1100px) {
    #flash-backup_beta-layout {
      grid-template-columns: 1fr;
    }
  }

  #flash-backup_beta-settings h2,
  #flash-backup_beta-settings h3 {
    margin-top: 0;
    margin-bottom: 12px;
  }

  #flash-backup_beta-settings {
    padding-top: 16px !important;
  }

  #cron-warning-fields,
  #cron-warning-minute,
  #cron-warning-interval {
    max-width: 360px;
    width: 100%;
    box-sizing: border-box;
    word-wrap: break-word;
    color: yellow;
  }

  #cron-warning-fields-remote,
  #cron-warning-slash-remote {
    max-width: 360px;
    width: 100%;
    box-sizing: border-box;
    word-wrap: break-word;
    color: yellow;
  }

  #logtoast,
  #popupMessageremote,
  #popupMessage {
    display: none;
    background: yellow;
    color: #000;
    padding: 6px 10px;
    border-radius: 4px;
    margin-top: 8px;
    font-weight: bold;
  }

  .minimal-backup-label {
    margin-left: 6px;
    color: var(--primary-blue);
    font-weight: bold;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 2px;
    position: relative;
    top: 3px;
  }

  .minimal-backup-label input[type="checkbox"] {
    transform: scale(1.1);
  }

  /* MAIN FIELD */
  .flash-multiselect {
    display: block;
    width: 200px;
    height: 2.4em;
    line-height: 2.4em;
    border: 1px solid #2ECC40;
    border-radius: 4px;
    padding: 0 0.5em;
    font-size: 1em;
    background-color: #111;
    box-sizing: border-box;
    cursor: pointer;
    position: relative;
    min-width: 0;
    max-width: 200px;
  }

  /* Placeholder text */
  .flash-multiselect .selected-placeholder {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #fff;
  }

  /* DROPDOWN CONTAINER */
  .flash-multiselect .options-container {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    border: 1px solid #2ECC40;
    border-top: none;
    background: #111;
    color: #fff;
    z-index: 10;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
  }

  /* ACTION ROW */
  .flash-multiselect .options-actions {
    display: flex;
    justify-content: space-between;
    gap: 0.5em;
    padding: 0.3em 0.4em;
    background: #0c0c0c;
  }

  /* SCROLL AREA */
  .flash-multiselect .options-list {
    max-height: 200px;
    overflow-y: auto;
  }

  /* BUTTONS */
  .flash-multiselect .options-actions button {
    font-size: 0.85em;
    padding: 0.15em 0.6em;
    border: 1px solid #2ECC40;
    background: #111;
    color: #2ECC40;
    border-radius: 3px;
    cursor: pointer;
  }

  .flash-multiselect .options-actions button:hover {
    background: #2ECC40;
    color: #000;
  }

  /* OPTIONS */
  .flash-multiselect .option {
    padding: 0.35em 0.5em;
    line-height: 1.6em;
    cursor: pointer;
  }

  .flash-multiselect .option:hover {
    background-color: #5a5959;
  }

  .flash-multiselect .option.selected {
    background-color: #4aa555;
    color: #fff;
  }

  .flash-backup_beta-schedules-table td {
    padding-top: 2px !important;
    padding-bottom: 2px !important;
  }
</style>

<?php
$plg = "/boot/config/plugins/flash-backup_beta.plg";
$version = "unknown";

if (is_file($plg)) {
    $xml = @simplexml_load_file($plg);
    if ($xml && isset($xml['version'])) {
        $version = (string)$xml['version'];
    }
}
?>

<div id="flash-backup_beta-layout">
  <div class="flash-backup_beta-wrapper">
    <form id="flash-backup_beta-settings">

      <div class="status-row"><span title="Shows which part of the backup to local storage process is currently running"
          class="flash-backup_betatip status-label">Status:</span><span id="status-text">Local Backup Not Running</span>
      </div>
      <br>

      <!-- BACKUP DESTINATION -->
      <div class="form-pair">
        <label>
          <span class="flash-backup_betatip" title="Choose destination for local backup">
            Backup Destination:
          </span>
        </label>

        <span class="flash-backup_betatip" title="Choose destination for local backup">
          <input type="text" id="backup_destination" name="BACKUP_DESTINATION"
            data-picker-title="Select Backup Destination" placeholder="Click here" readonly style="cursor:pointer;"
            value="<?php echo htmlspecialchars($settings['BACKUP_DESTINATION'] ?? ''); ?>">
        </span>
      </div>

      <!-- BACKUPS TO KEEP -->
      <div class="form-pair">
        <label for="backups_to_keep">
          <span title="Choose the amount of backups to keep for your local backups" class="flash-backup_betatip">
            Backups To Keep:
          </span>
        </label>

        <span title="Choose the amount of backups to keep for your local backups" class="flash-backup_betatip">
          <select id="backups_to_keep" class="short-input" name="BACKUPS_TO_KEEP">
            <?php
        $current = $settings['BACKUPS_TO_KEEP'] ?? 0;

        for ($i = 0; $i <= 99; $i++) {
          $selected = ((int)$current === $i) ? 'selected' : '';

          if ($i === 0) {
            echo "<option value=\"0\" $selected>Unlimited</option>";
          } elseif ($i === 1) {
            echo "<option value=\"1\" $selected>Only Latest</option>";
          } else {
            echo "<option value=\"$i\" $selected>$i</option>";
          }
        }
      ?>
          </select>
        </span>
      </div>

      <!-- BACKUP OWNER -->
      <div class="form-pair">
        <label>
          <span class="flash-backup_betatip"
            title="Choose the owner for the local backup if you wanted it owned by one of your created users">
            Backup Owner:
          </span>
        </label>

        <span class="flash-backup_betatip"
          title="Choose the owner for the local backup if you wanted it owned by one of your created users">
          <select id="backup_owner" name="BACKUP_OWNER"
            data-selected="<?php echo htmlspecialchars($settings['BACKUP_OWNER'] ?? 'nobody'); ?>">
          </select>
        </span>
      </div>

      <!-- DRY RUN -->
      <div class="form-pair">
        <label for="dry_run">
          <span class="flash-backup_betatip" title="Enable to simulate the local backup">
            Dry Run:
          </span>
        </label>

        <span class="flash-backup_betatip" title="Enable to simulate the local backup">
          <select id="dry_run" class="short-input" name="DRY_RUN">
            <option value="yes" <?=(($settings['DRY_RUN'] ?? 'no' )==='yes' ) ? 'selected' : '' ?>>
              Yes
            </option>
            <option value="no" <?=(($settings['DRY_RUN'] ?? 'no' )==='no' ) ? 'selected' : '' ?>>
              No
            </option>
          </select>
        </span>
      </div>

      <!-- NOTIFICATIONS -->
      <div class="form-pair">
        <label for="notifications">
          <span class="flash-backup_betatip"
            title="Send unraid system notifications when flash backup to local storage starts and finishes">
            Notifications:
          </span>
        </label>

        <span class="flash-backup_betatip"
          title="Send unraid system notifications when flash backup to local storage starts and finishes">
          <select id="notifications" class="short-input" name="NOTIFICATIONS">
            <option value="yes" <?=(($settings['NOTIFICATIONS'] ?? 'no' )==='yes' ) ? 'selected' : '' ?>>
              Yes
            </option>
            <option value="no" <?=(($settings['NOTIFICATIONS'] ?? 'no' )==='no' ) ? 'selected' : '' ?>>
              No
            </option>
          </select>
        </span>
      </div>

      <!-- DISCORD WEBHOOK URL -->
      <div class="form-pair" id="discord-webhook-row" style="display:none;">
        <label for="discord_webhook_url">
          <span class="flash-backup_betatip"
            title="Optional: Enter a webhook URL (Discord, Slack, Teams, Gotify, pushover, or Ntfy) to send notifications instead of Unraid">
            Webhook URL:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="flash-backup_betatip"
            title="Optional: Enter a webhook URL (Discord, Slack, Teams, Gotify, pushover, or Ntfy) to send notifications instead of Unraid">
            <input type="text" id="discord_webhook_url" name="DISCORD_WEBHOOK_URL" class="short-input"
              placeholder="Webhook URL" value="<?php echo htmlspecialchars($settings['DISCORD_WEBHOOK_URL'] ?? ''); ?>">
          </span>
          <div id="discord-webhook-error" style="color:yellow; font-size:1.00em; display:none;">* Must be a valid
            webhook URL (Discord, Slack, Teams, Gotify, Pushover, or Ntfy)</div>
        </div>
      </div>

      <!-- PUSHOVER USER KEY -->
      <div class="form-pair" id="pushover-user-key-row" style="display:none;">
        <label for="pushover_user_key">
          <span class="flash-backup_betatip" title="Your Pushover user key from pushover.net/dashboard">
            Pushover User Key:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="flash-backup_betatip" title="Your Pushover user key from pushover.net/dashboard">
            <input type="text" id="pushover_user_key" name="PUSHOVER_USER_KEY" class="short-input"
              placeholder="user key from pushover.net"
              value="<?php echo htmlspecialchars($settings['PUSHOVER_USER_KEY'] ?? ''); ?>">
          </span>
          <div id="pushover-user-key-error" style="color:yellow; font-size:1.00em; display:none;">* Pushover user key is
            required</div>
        </div>
      </div>

      <!-- Scheduling Selection -->
      <div class="form-pair" id="cron-expression-row">
        <label for="cron_mode">
          <span class="flash-backup_betatip" title="Select scheduling selection">
            Scheduling:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="flash-backup_betatip" title="Select scheduling selection">
            <select id="cron_mode" name="CRON_MODE" class="short-input">
              <option value="minutes" <?php echo (($settings['CRON_MODE'] ?? '' )==='minutes' ) ? 'selected' : '' ; ?>
                >Minutes</option>
              <option value="hourly" <?php echo (($settings['CRON_MODE'] ?? '' )==='hourly' ) ? 'selected' : '' ; ?>
                >Hourly</option>
              <option value="daily" <?php echo (($settings['CRON_MODE'] ?? 'daily' )==='daily' ) ? 'selected' : '' ; ?>
                >Daily
              </option>
              <option value="weekly" <?php echo (($settings['CRON_MODE'] ?? '' )==='weekly' ) ? 'selected' : '' ; ?>
                >Weekly</option>
              <option value="monthly" <?php echo (($settings['CRON_MODE'] ?? '' )==='monthly' ) ? 'selected' : '' ; ?>
                >Monthly</option>
              <option value="custom" <?php echo (($settings['CRON_MODE'] ?? '' )==='custom' ) ? 'selected' : '' ; ?>
                >Custom</option>
            </select>
          </span>
        </div>
      </div>

      <!-- Minutes Options -->
      <div id="minutes-options" style="display:none; margin-top:10px;">
        <div class="form-pair">
          <label for="minutes_frequency">
            <span class="flash-backup_betatip" title="Select minute frequency">
              Select Frequency:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select minute frequency">

              <?php
          $raw = $settings['MINUTES_FREQUENCY'] ?? '';
          $freq = intval($raw);
          if ($freq < 1) $freq = 30;
        ?>

              <select id="minutes_frequency" name="MINUTES_FREQUENCY" class="short-input">
                <?php
            for ($i = 1; $i <= 59; $i++) {
              $selected = ($freq === $i) ? 'selected' : '';
              echo "<option value=\"$i\" $selected>Every $i Minutes</option>";
            }
          ?>
              </select>

            </span>
          </div>
        </div>
      </div>

      <!-- Hourly Options -->
      <div id="hourly-options" style="display:none; margin-top:10px;">
        <div class="form-pair">
          <label for="hourly_frequency">
            <span class="flash-backup_betatip" title="Select hourly frequency">
              Select Frequency:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select hourly frequency">
              <select id="hourly_frequency" name="HOURLY_FREQUENCY" class="short-input">
                <?php
          for ($i = 1; $i <= 23; $i++) {
              $selected = (($settings['HOURLY_FREQUENCY'] ?? '') === (string)$i) ? 'selected' : '';
              echo "<option value=\"$i\" $selected>Every $i Hour" . ($i > 1 ? 's' : '') . "</option>";
          }
          ?>
              </select>
            </span>
          </div>
        </div>
      </div>

      <!-- Daily Options -->
      <div id="daily-options" style="display:none; margin-top:10px;">
        <div class="form-pair">
          <label for="daily_time">
            <span class="flash-backup_betatip" title="Select the hour for daily execution">
              Hour:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select the hour for daily execution">
              <select id="daily_time" name="DAILY_TIME" class="short-input">
                <?php for ($h = 0; $h < 24; $h++):
                $hour = str_pad($h, 2, "0", STR_PAD_LEFT); ?>
                <option value="<?php echo $hour; ?>" <?php echo (($settings['DAILY_TIME'] ?? '00' )===$hour)
                  ? 'selected' : '' ; ?>>
                  <?php echo $hour; ?>
                </option>
                <?php endfor; ?>
              </select>
            </span>
          </div>
        </div>
        <div class="form-pair">
          <label for="daily_minute">
            <span class="flash-backup_betatip" title="Select the minute for daily execution">
              Minute:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select the minute for daily execution">
              <select id="daily_minute" name="DAILY_MINUTE" class="short-input">
                <?php for ($m = 0; $m < 60; $m++):
                $min = str_pad($m, 2, "0", STR_PAD_LEFT); ?>
                <option value="<?php echo $min; ?>" <?php echo (($settings['DAILY_MINUTE'] ?? '00' )===$min)
                  ? 'selected' : '' ; ?>>
                  <?php echo $min; ?>
                </option>
                <?php endfor; ?>
              </select>
            </span>
          </div>
        </div>
      </div>

      <!-- Weekly Options -->
      <div id="weekly-options" style="display:none; margin-top:10px;">
        <div class="form-pair">
          <label for="weekly_day">
            <span class="flash-backup_betatip" title="Select day of the week">
              Day Of Week:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select day of the week">
              <select id="weekly_day" name="WEEKLY_DAY" class="short-input">
                <?php 
            $days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
            foreach ($days as $day): ?>
                <option value="<?php echo $day; ?>" <?php echo (($settings['WEEKLY_DAY'] ?? '' )===$day) ? 'selected'
                  : '' ; ?>>
                  <?php echo $day; ?>
                </option>
                <?php endforeach; ?>
              </select>
            </span>
          </div>
        </div>
        <div class="form-pair">
          <label for="weekly_time">
            <span class="flash-backup_betatip" title="Select the hour for weekly execution">
              Hour:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select the hour for weekly execution">
              <select id="weekly_time" name="WEEKLY_TIME" class="short-input">
                <?php for ($h = 0; $h < 24; $h++):
                $hour = str_pad($h, 2, "0", STR_PAD_LEFT); ?>
                <option value="<?php echo $hour; ?>" <?php echo (($settings['WEEKLY_TIME'] ?? '00' )===$hour)
                  ? 'selected' : '' ; ?>>
                  <?php echo $hour; ?>
                </option>
                <?php endfor; ?>
              </select>
            </span>
          </div>
        </div>
        <div class="form-pair">
          <label for="weekly_minute">
            <span class="flash-backup_betatip" title="Select the minute for weekly execution">
              Minute:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select the minute for weekly execution">
              <select id="weekly_minute" name="WEEKLY_MINUTE" class="short-input">
                <?php for ($m = 0; $m < 60; $m++):
                $min = str_pad($m, 2, "0", STR_PAD_LEFT); ?>
                <option value="<?php echo $min; ?>" <?php echo (($settings['WEEKLY_MINUTE'] ?? '00' )===$min)
                  ? 'selected' : '' ; ?>>
                  <?php echo $min; ?>
                </option>
                <?php endfor; ?>
              </select>
            </span>
          </div>
        </div>
      </div>

      <!-- Monthly Options -->
      <div id="monthly-options" style="display:none; margin-top:10px;">
        <div class="form-pair">
          <label for="monthly_day">
            <span class="flash-backup_betatip" title="Select day of the month">
              Day Of Month:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select day of the month">
              <select id="monthly_day" name="MONTHLY_DAY" class="short-input">
                <?php for ($d = 1; $d <= 31; $d++): 
            $day = str_pad($d, 2, "0", STR_PAD_LEFT); ?>
                <option value="<?php echo $day; ?>" <?php echo (($settings['MONTHLY_DAY'] ?? '' )===$day) ? 'selected'
                  : '' ; ?>>
                  <?php echo $day; ?>
                </option>
                <?php endfor; ?>
              </select>
            </span>
          </div>
        </div>
        <div class="form-pair">
          <label for="monthly_time">
            <span class="flash-backup_betatip" title="Select the hour for monthly execution">
              Hour:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select the hour for monthly execution">
              <select id="monthly_time" name="MONTHLY_TIME" class="short-input">
                <?php for ($h = 0; $h < 24; $h++):
                $hour = str_pad($h, 2, "0", STR_PAD_LEFT); ?>
                <option value="<?php echo $hour; ?>" <?php echo (($settings['MONTHLY_TIME'] ?? '00' )===$hour)
                  ? 'selected' : '' ; ?>>
                  <?php echo $hour; ?>
                </option>
                <?php endfor; ?>
              </select>
            </span>
          </div>
        </div>
        <div class="form-pair">
          <label for="monthly_minute">
            <span class="flash-backup_betatip" title="Select the minute for monthly execution">
              Minute:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select the minute for monthly execution">
              <select id="monthly_minute" name="MONTHLY_MINUTE" class="short-input">
                <?php for ($m = 0; $m < 60; $m++):
                $min = str_pad($m, 2, "0", STR_PAD_LEFT); ?>
                <option value="<?php echo $min; ?>" <?php echo (($settings['MONTHLY_MINUTE'] ?? '00' )===$min)
                  ? 'selected' : '' ; ?>>
                  <?php echo $min; ?>
                </option>
                <?php endfor; ?>
              </select>
            </span>
          </div>
        </div>
      </div>

      <!-- Custom Option -->
      <div id="custom-options" style="display:none; margin-top:10px;">
        <div class="form-pair">
          <label for="custom_cron">
            <span class="flash-backup_betatip"
              title="Enter a valid cron expression 5 fields with spaces between each for example */2 * * * * visit https://crontab.guru for help">
              Cron Expression:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip"
              title="Enter a valid cron expression 5 fields with spaces between each for example */2 * * * * visit https://crontab.guru for help">
              <input type="text" id="custom_cron" name="CUSTOM_CRON" class="short-input" placeholder="*/2 * * * *"
                value="<?php echo htmlspecialchars($settings['CUSTOM_CRON'] ?? ''); ?>">
            </span>
          </div>
        </div>

        <div class="form-pair">

          <!-- Wrong number of fields OR invalid characters -->
          <div id="cron-warning-fields" class="field-warning" role="alert" style="display:none;">
            ⚠️ Enter a valid cron expression with 5 fields separated by spaces.
            Only numbers, *, and / are allowed.
            Visit <a href="https://crontab.guru/" target="_blank">crontab.guru</a> for help.
          </div>

          <!-- Slash rule: must be exactly */N -->
          <div id="cron-warning-slash" class="field-warning" role="alert" style="display:none;">
            ⚠️ Fields using "/" must be in the form */N (example: */5).
          </div>

        </div>
      </div>

      <div id="backup-status" style="color:yellow; font-weight:bold; margin-bottom:6px; display:none;">
        Local or Remote backup in progress!
      </div>

      <!-- Local Backup Button-->
      <div class="backup-actions">
        <span title="Run backup of flash drive to local storage" class="flash-backup_betatip">
          <button type="button" id="backupbtn">Backup Now</button>
        </span>

        <span class="flash-backup_betatip"
          data-tooltip="Create a local backup schedule using the settings shown in the fields above">
          <button type="button" id="schedule-local-backup" class="button schedule-button">Schedule It</button>
        </span>

        <span title="Cancel editing of schedule" class="flash-backup_betatip">
          <button type="button" id="cancelEditBtn" style="display:none;">Cancel</button>
        </span>

        <!-- Minimal Backup Checkbox -->
        <label class="minimal-backup-label flash-backup_betatip"
          title="Enable to have the local backup only include the config and extra folders, and the syslinux.cfg file">
          <input type="checkbox" id="minimal_backup" name="MINIMAL_BACKUP" value="yes" <?php echo
            (($settings['MINIMAL_BACKUP'] ?? 'no' )==='yes' ) ? 'checked' : '' ; ?>>
          Minimal Backup
        </label>
      </div>

      <div id="popupMessage"></div>

    </form>
  </div>

  <div class="flash-backup_beta-wrapper">
    <form id="flash-backup_beta-settings-remote">

      <div class="status-row">
        <span title="Shows which part of the backup to remote storage process is currently running"
          class="flash-backup_betatip status-label">Status:</span>
        <span id="status-text-remote">Remote Backup Not Running</span>
      </div>
      <br>

      <?php
// --- Parse rclone config ---
$rcloneConfig = '/boot/config/plugins/rclone/.rclone.conf';
$rcloneIni = [];
$rcloneRemotes = [];
$remoteTypes = [];

if (file_exists($rcloneConfig)) {
    $rcloneIni = parse_ini_file($rcloneConfig, true, INI_SCANNER_RAW);
    if (is_array($rcloneIni)) {
        $rcloneRemotes = array_keys($rcloneIni);
        sort($rcloneRemotes, SORT_NATURAL | SORT_FLAG_CASE);
        foreach ($rcloneRemotes as $remote) {
            $type = $rcloneIni[$remote]['type'] ?? 'unknown';
            $remoteTypes[$remote] = $type;

            // If crypt, check if its underlying remote is b2
            if ($type === 'crypt') {
                $underlying = $rcloneIni[$remote]['remote'] ?? '';
                $underlyingRemote = explode(':', $underlying)[0];
                if (($rcloneIni[$underlyingRemote]['type'] ?? '') === 'b2') {
                    $remoteTypes[$remote] = 'crypt-b2';
                }
            }
        }
    }
}

// --- Load saved selection ---
$saved = $remotesettings['RCLONE_CONFIG_REMOTE'] ?? '';
$selectedRemotes = array_filter(array_map('trim', explode(',', $saved)));
?>

      <!-- RCLONE CONFIG REMOTE -->
      <div class="form-pair">
        <label>
          <span class="flash-backup_betatip" title="Choose which rclone config(s) to use for the remote backup">
            Rclone Config:
          </span>
        </label>

        <span class="form-input"> <!-- important for width/height -->
          <!-- Hidden select for form submission -->
          <select id="rclone_config_remote_hidden" name="RCLONE_CONFIG_REMOTE[]" multiple style="display:none;">
            <?php foreach ($rcloneRemotes as $remote): ?>
            <option value="<?= htmlspecialchars($remote) ?>" <?=in_array($remote, $selectedRemotes, true) ? 'selected'
              : '' ?>>
              <?= htmlspecialchars($remote) ?>
            </option>
            <?php endforeach; ?>
          </select>

          <!-- Custom dropdown styled to match form-input -->
          <div id="rclone_config_remote" class="flash-multiselect">
            <span class="selected-placeholder">
              <?= !empty($selectedRemotes) ? implode(', ', $selectedRemotes) : 'Select config(s)' ?>
            </span>
            <div class="options-container">

              <!-- ACTION ROW (NOT SCROLLABLE) -->
              <div class="options-actions">
                <button type="button" class="select-all">Select all</button>
                <button type="button" class="clear-all">Clear</button>
              </div>

              <!-- SCROLLABLE OPTIONS -->
              <div class="options-list">
                <?php foreach ($rcloneRemotes as $remote): ?>
                <?php $type = $rcloneIni[$remote]['type'] ?? 'unknown'; ?>
                <div class="option" data-value="<?= htmlspecialchars($remote) ?>">
                  <?= htmlspecialchars("$type - $remote") ?>
                </div>
                <?php endforeach; ?>
              </div>

            </div>
          </div>
        </span>
      </div>

      <!-- B2 BUCKET NAME -->
      <div class="form-pair" id="b2_bucket_row" style="display:none;">
        <label>
          <span class="flash-backup_betatip" title="Required for Backblaze B2 remotes — the bucket name to upload into">
            B2 Bucketname:
          </span>
        </label>
        <span class="form-input">
          <input type="text" id="b2_bucket_name" name="B2_BUCKET_NAME" placeholder="/folder/" autocomplete="off"
            value="<?= htmlspecialchars($remotesettings['B2_BUCKET_NAME'] ?? '') ?>">
        </span>
      </div>

      <!-- PATH IN CONFIG REMOTE -->
      <div class="form-pair">
        <label>
          <span class="flash-backup_betatip"
            title="Optional: subfolder where backups will be stored. If left empty /Flash_Backups/ will be used">
            Folder:
          </span>
        </label>
        <span class="flash-backup_betatip"
          title="Optional: subfolder where backups will be stored. If left empty /Flash_Backups/ will be used">
          <input type="text" name="REMOTE_PATH_IN_CONFIG" id="remote_path_in_config" placeholder="/folder/subfolder"
            value="<?= htmlspecialchars($remotesettings['REMOTE_PATH_IN_CONFIG'] ?? '') ?>">
        </span>
      </div>


      <!-- BACKUPS TO KEEP REMOTE -->
      <div class="form-pair">
        <label for="backups_to_keep_remote">
          <span title="Choose the amount of backups to keep for your remote backups" class="flash-backup_betatip">
            Backups To Keep:
          </span>
        </label>

        <span title="Choose the amount of backups to keep for your remote backups" class="flash-backup_betatip">
          <select id="backups_to_keep_remote" class="short-input" name="BACKUPS_TO_KEEP_REMOTE">
            <?php
            $current = $remotesettings['BACKUPS_TO_KEEP_REMOTE'] ?? 0;

            for ($i = 0; $i <= 99; $i++) {
              $selected = ((int)$current === $i) ? 'selected' : '';

              if ($i === 0) {
                echo "<option value=\"0\" $selected>Unlimited</option>";
              } elseif ($i === 1) {
                echo "<option value=\"1\" $selected>Only Latest</option>";
              } else {
                echo "<option value=\"$i\" $selected>$i</option>";
              }
            }
          ?>
          </select>
        </span>
      </div>

      <!-- DRY RUN REMOTE -->
      <div class="form-pair">
        <label for="dry_run_remote">
          <span class="flash-backup_betatip" title="Enable to simulate the remote backup">
            Dry Run:
          </span>
        </label>

        <span class="flash-backup_betatip" title="Enable to simulate the remote backup">
          <select id="dry_run_remote" class="short-input" name="DRY_RUN_REMOTE">
            <option value="yes" <?=(($remotesettings['DRY_RUN_REMOTE'] ?? 'no' )==='yes' ) ? 'selected' : '' ?>>Yes
            </option>
            <option value="no" <?=(($remotesettings['DRY_RUN_REMOTE'] ?? 'no' )==='no' ) ? 'selected' : '' ?>>No
            </option>
          </select>
        </span>
      </div>

      <!-- NOTIFICATIONS REMOTE -->
      <div class="form-pair">
        <label for="notifications_remote">
          <span class="flash-backup_betatip"
            title="Send unraid system notifications when flash backup to remote storage starts and finishes">
            Notifications:
          </span>
        </label>

        <span class="flash-backup_betatip"
          title="Send unraid system notifications when flash backup to remote storage starts and finishes">
          <select id="notifications_remote" class="short-input" name="NOTIFICATIONS_REMOTE">
            <option value="yes" <?=(($remotesettings['NOTIFICATIONS_REMOTE'] ?? 'no' )==='yes' ) ? 'selected' : '' ?>
              >Yes
            </option>
            <option value="no" <?=(($remotesettings['NOTIFICATIONS_REMOTE'] ?? 'no' )==='no' ) ? 'selected' : '' ?>>No
            </option>
          </select>
        </span>
      </div>

      <!-- DISCORD WEBHOOK URL REMOTE -->
      <div class="form-pair" id="discord-webhook-row-remote" style="display:none;">
        <label for="discord_webhook_url_remote">
          <span class="flash-backup_betatip"
            title="Optional: Enter a webhook URL (Discord, Slack, Teams, Gotify, pushover, or Ntfy) to send notifications instead of Unraid">
            Webhook URL:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="flash-backup_betatip"
            title="Optional: Enter a webhook URL (Discord, Slack, Teams, Gotify, pushover, or Ntfy) to send notifications instead of Unraid">
            <input type="text" id="discord_webhook_url_remote" name="DISCORD_WEBHOOK_URL_REMOTE" class="short-input"
              placeholder="Webhook URL"
              value="<?php echo htmlspecialchars($remotesettings['DISCORD_WEBHOOK_URL_REMOTE'] ?? ''); ?>">
          </span>
          <div id="discord-webhook-error-remote" style="color:yellow; font-size:1.00em; display:none;">* Must be a valid
            webhook URL (Discord, Slack, Teams, Gotify, Pushover, or Ntfy)</div>
        </div>
      </div>

      <!-- PUSHOVER USER KEY REMOTE -->
      <div class="form-pair" id="pushover-user-key-row-remote" style="display:none;">
        <label for="pushover_user_key_remote">
          <span class="flash-backup_betatip" title="Your Pushover user key from pushover.net/dashboard">
            Pushover User Key:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="flash-backup_betatip" title="Your Pushover user key from pushover.net/dashboard">
            <input type="text" id="pushover_user_key_remote" name="PUSHOVER_USER_KEY_REMOTE" class="short-input"
              placeholder="user key from pushover.net"
              value="<?php echo htmlspecialchars($remotesettings['PUSHOVER_USER_KEY_REMOTE'] ?? ''); ?>">
          </span>
          <div id="pushover-user-key-error-remote" style="color:yellow; font-size:1.00em; display:none;">* Pushover user
            key is required</div>
        </div>
      </div>

      <!-- Scheduling Selection -->
      <div class="form-pair" id="cron-expression-row-remote">
        <label for="cron_mode_remote">
          <span class="flash-backup_betatip" title="Select scheduling selection">
            Scheduling:
          </span>
        </label>
        <div class="input-wrapper">
          <span class="flash-backup_betatip" title="Select scheduling selection">
            <select id="cron_mode_remote" name="CRON_MODE_REMOTE" class="short-input">
              <option value="minutes" <?=(($remotesettings['CRON_MODE_REMOTE'] ?? '' )==='minutes' ) ? 'selected' : ''
                ?>
                >Minutes</option>
              <option value="hourly" <?=(($remotesettings['CRON_MODE_REMOTE'] ?? '' )==='hourly' ) ? 'selected' : '' ?>
                >Hourly
              </option>
              <option value="daily" <?=(($remotesettings['CRON_MODE_REMOTE'] ?? 'daily' )==='daily' ) ? 'selected' : ''
                ?>
                >Daily
              </option>
              <option value="weekly" <?=(($remotesettings['CRON_MODE_REMOTE'] ?? '' )==='weekly' ) ? 'selected' : '' ?>
                >Weekly
              </option>
              <option value="monthly" <?=(($remotesettings['CRON_MODE_REMOTE'] ?? '' )==='monthly' ) ? 'selected' : ''
                ?>
                >Monthly</option>
              <option value="custom" <?=(($remotesettings['CRON_MODE_REMOTE'] ?? '' )==='custom' ) ? 'selected' : '' ?>
                >Custom
              </option>
            </select>
          </span>
        </div>
      </div>

      <!-- Minutes Options -->
      <div id="minutes-options-remote" style="display:none; margin-top:10px;">
        <div class="form-pair">
          <label for="minutes_frequency_remote">
            <span class="flash-backup_betatip" title="Select minute frequency">
              Select Frequency:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select minute frequency">

              <?php
              $raw = $remotesettings['MINUTES_FREQUENCY_REMOTE'] ?? '';
              $freq = intval($raw);
              if ($freq < 1) $freq = 30;
            ?>

              <select id="minutes_frequency_remote" name="MINUTES_FREQUENCY_REMOTE" class="short-input">
                <?php
                for ($i = 1; $i <= 59; $i++) {
                  $selected = ($freq === $i) ? 'selected' : '';
                  echo "<option value=\"$i\" $selected>Every $i Minutes</option>";
                }
              ?>
              </select>

            </span>
          </div>
        </div>
      </div>

      <!-- Hourly Options -->
      <div id="hourly-options-remote" style="display:none; margin-top:10px;">
        <div class="form-pair">
          <label for="hourly_frequency_remote">
            <span class="flash-backup_betatip" title="Select hourly frequency">
              Select Frequency:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select hourly frequency">
              <select id="hourly_frequency_remote" name="HOURLY_FREQUENCY_REMOTE" class="short-input">
                <?php
                for ($i = 1; $i <= 23; $i++) {
                  $selected = (($remotesettings['HOURLY_FREQUENCY_REMOTE'] ?? '') === (string)$i) ? 'selected' : '';
                  echo "<option value=\"$i\" $selected>Every $i Hour" . ($i > 1 ? 's' : '') . "</option>";
                }
              ?>
              </select>
            </span>
          </div>
        </div>
      </div>

      <!-- Daily Options -->
      <div id="daily-options-remote" style="display:none; margin-top:10px;">
        <div class="form-pair">
          <label for="daily_time_remote">
            <span class="flash-backup_betatip" title="Select the hour for daily execution">
              Hour:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select the hour for daily execution">
              <select id="daily_time_remote" name="DAILY_TIME_REMOTE" class="short-input">
                <?php for ($h = 0; $h < 24; $h++):
                $hour = str_pad($h, 2, "0", STR_PAD_LEFT); ?>
                <option value="<?php echo $hour; ?>" <?php echo (($remotesettings['DAILY_TIME_REMOTE'] ?? '00'
                  )===$hour) ? 'selected' : '' ; ?>>
                  <?php echo $hour; ?>
                </option>
                <?php endfor; ?>
              </select>
            </span>
          </div>
        </div>
        <div class="form-pair">
          <label for="daily_minute_remote">
            <span class="flash-backup_betatip" title="Select the minute for daily execution">
              Minute:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select the minute for daily execution">
              <select id="daily_minute_remote" name="DAILY_MINUTE_REMOTE" class="short-input">
                <?php for ($m = 0; $m < 60; $m++):
                $min = str_pad($m, 2, "0", STR_PAD_LEFT); ?>
                <option value="<?php echo $min; ?>" <?php echo (($remotesettings['DAILY_MINUTE_REMOTE'] ?? '00'
                  )===$min) ? 'selected' : '' ; ?>>
                  <?php echo $min; ?>
                </option>
                <?php endfor; ?>
              </select>
            </span>
          </div>
        </div>
      </div>

      <!-- Weekly Options -->
      <div id="weekly-options-remote" style="display:none; margin-top:10px;">
        <div class="form-pair">
          <label for="weekly_day_remote">
            <span class="flash-backup_betatip" title="Select day of the week">
              Day Of Week:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select day of the week">
              <select id="weekly_day_remote" name="WEEKLY_DAY_REMOTE" class="short-input">
                <?php
                $days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
                foreach ($days as $day): ?>
                <option value="<?php echo $day; ?>" <?php echo (($remotesettings['WEEKLY_DAY_REMOTE'] ?? '' )===$day)
                  ? 'selected' : '' ; ?>>
                  <?php echo $day; ?>
                </option>
                <?php endforeach; ?>
              </select>
            </span>
          </div>
        </div>
        <div class="form-pair">
          <label for="weekly_time_remote">
            <span class="flash-backup_betatip" title="Select the hour for weekly execution">
              Hour:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select the hour for weekly execution">
              <select id="weekly_time_remote" name="WEEKLY_TIME_REMOTE" class="short-input">
                <?php for ($h = 0; $h < 24; $h++):
                $hour = str_pad($h, 2, "0", STR_PAD_LEFT); ?>
                <option value="<?php echo $hour; ?>" <?php echo (($remotesettings['WEEKLY_TIME_REMOTE'] ?? '00'
                  )===$hour) ? 'selected' : '' ; ?>>
                  <?php echo $hour; ?>
                </option>
                <?php endfor; ?>
              </select>
            </span>
          </div>
        </div>
        <div class="form-pair">
          <label for="weekly_minute_remote">
            <span class="flash-backup_betatip" title="Select the minute for weekly execution">
              Minute:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select the minute for weekly execution">
              <select id="weekly_minute_remote" name="WEEKLY_MINUTE_REMOTE" class="short-input">
                <?php for ($m = 0; $m < 60; $m++):
                $min = str_pad($m, 2, "0", STR_PAD_LEFT); ?>
                <option value="<?php echo $min; ?>" <?php echo (($remotesettings['WEEKLY_MINUTE_REMOTE'] ?? '00'
                  )===$min) ? 'selected' : '' ; ?>>
                  <?php echo $min; ?>
                </option>
                <?php endfor; ?>
              </select>
            </span>
          </div>
        </div>
      </div>

      <!-- Monthly Options -->
      <div id="monthly-options-remote" style="display:none; margin-top:10px;">
        <div class="form-pair">
          <label for="monthly_day_remote">
            <span class="flash-backup_betatip" title="Select day of the month">
              Day Of Month:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select day of the month">
              <select id="monthly_day_remote" name="MONTHLY_DAY_REMOTE" class="short-input">
                <?php for ($d = 1; $d <= 31; $d++):
                $day = str_pad($d, 2, "0", STR_PAD_LEFT); ?>
                <option value="<?php echo $day; ?>" <?php echo (($remotesettings['MONTHLY_DAY_REMOTE'] ?? '' )===$day)
                  ? 'selected' : '' ; ?>>
                  <?php echo $day; ?>
                </option>
                <?php endfor; ?>
              </select>
            </span>
          </div>
        </div>
        <div class="form-pair">
          <label for="monthly_time_remote">
            <span class="flash-backup_betatip" title="Select the hour for monthly execution">
              Hour:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select the hour for monthly execution">
              <select id="monthly_time_remote" name="MONTHLY_TIME_REMOTE" class="short-input">
                <?php for ($h = 0; $h < 24; $h++):
                $hour = str_pad($h, 2, "0", STR_PAD_LEFT); ?>
                <option value="<?php echo $hour; ?>" <?php echo (($remotesettings['MONTHLY_TIME_REMOTE'] ?? '00'
                  )===$hour) ? 'selected' : '' ; ?>>
                  <?php echo $hour; ?>
                </option>
                <?php endfor; ?>
              </select>
            </span>
          </div>
        </div>
        <div class="form-pair">
          <label for="monthly_minute_remote">
            <span class="flash-backup_betatip" title="Select the minute for monthly execution">
              Minute:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip" title="Select the minute for monthly execution">
              <select id="monthly_minute_remote" name="MONTHLY_MINUTE_REMOTE" class="short-input">
                <?php for ($m = 0; $m < 60; $m++):
                $min = str_pad($m, 2, "0", STR_PAD_LEFT); ?>
                <option value="<?php echo $min; ?>" <?php echo (($remotesettings['MONTHLY_MINUTE_REMOTE'] ?? '00'
                  )===$min) ? 'selected' : '' ; ?>>
                  <?php echo $min; ?>
                </option>
                <?php endfor; ?>
              </select>
            </span>
          </div>
        </div>
      </div>

      <!-- Custom Option -->
      <div id="custom-options-remote" style="display:none; margin-top:10px;">
        <div class="form-pair">
          <label for="custom_cron_remote">
            <span class="flash-backup_betatip"
              title="Enter a valid cron expression 5 fields with spaces between each for example */2 * * * * visit https://crontab.guru for help">
              Cron Expression:
            </span>
          </label>
          <div class="input-wrapper">
            <span class="flash-backup_betatip"
              title="Enter a valid cron expression 5 fields with spaces between each for example */2 * * * * visit https://crontab.guru for help">
              <input type="text" id="custom_cron_remote" name="CUSTOM_CRON_REMOTE" class="short-input"
                placeholder="*/2 * * * *"
                value="<?php echo htmlspecialchars($remotesettings['CUSTOM_CRON_REMOTE'] ?? ''); ?>">
            </span>
          </div>
        </div>

        <div class="form-pair">

          <!-- Wrong number of fields OR invalid characters -->
          <div id="cron-warning-fields-remote" class="field-warning" role="alert" style="display:none;">
            ⚠️ Enter a valid cron expression with 5 fields separated by spaces.
            Only numbers, *, and / are allowed.
            Visit <a href="https://crontab.guru/" target="_blank">crontab.guru</a> for help.
          </div>

          <!-- Slash rule: must be exactly */N -->
          <div id="cron-warning-slash-remote" class="field-warning" role="alert" style="display:none;">
            ⚠️ Fields using "/" must be in the form */N (example: */5).
          </div>

        </div>
      </div>

      <div id="backup-status-remote" style="color:yellow; font-weight:bold; margin-bottom:6px; display:none;">
        Local or Remote backup in progress!
      </div>

      <!-- Remote Backup Button-->
      <div class="backup-actions">
        <span title="Run remote backup" class="flash-backup_betatip">
          <button type="button" id="backupbtn_remote">Backup Now</button>
        </span>

        <span title="Create a remote backup schedule using the settings shown in the fields above"
          class="flash-backup_betatip">
          <button type="button" id="schedule-remote-backup" class="button schedule-button">Schedule It</button>
        </span>

        <span title="Cancel editing of remote schedule" class="flash-backup_betatip">
          <button type="button" id="cancelEditBtnremote" style="display:none;">Cancel</button>
        </span>

        <!-- Minimal Backup Checkbox -->
        <label class="minimal-backup-label flash-backup_betatip"
          title="Enable to have the remote backup only include the config and extra folders, and the syslinux.cfg file">
          <input type="checkbox" id="minimal_backup_remote" name="MINIMAL_BACKUP_REMOTE" value="yes" <?php echo
            (($remotesettings['MINIMAL_BACKUP_REMOTE'] ?? 'no' )==='yes' ) ? 'checked' : '' ; ?>>
          Minimal Backup
        </label>
      </div>

      <div id="popupMessageremote"></div>

    </form>
  </div>

  <div id="log-section">
    <form id="log-section-form">

      <div class="log-header-row">
        <span title="Clear the flash backup log" class="flash-backup_betatip">
          <button type="button" id="clear-last-run-log">Clear Log</button>
        </span>

        <div id="logtoast">Log copied</div>
        <span title="Copy flash backup log to clipboard" class="flash-backup_betatip">
          <button type="button" id="copy-last-run-log">Copy</button>
        </span>
      </div>

      <pre id="last-run-log">Flash backup log not found</pre>
  </div>

  </form>
</div>

<div id="schedule-list"></div>

<div id="schedule-list-remote"></div>

</div>

<div id="folderPickerModal" class="vm-modal">
  <div class="vm-modal-content">
    <div class="vm-modal-header">
      <span id="folderPickerTitle">Select Folder</span>
      <button type="button" id="closeFolderPicker">Close</button>
    </div>

    <div id="folderBreadcrumb" class="vm-breadcrumb"></div>

    <div id="folderList" class="vm-folder-list"></div>

    <div class="vm-modal-footer"
      style="display:flex; align-items:center; justify-content:flex-end; gap:12px; position:relative;">

      <div class="vm-modal-footer" style="position:relative;">

        <div id="folderToast" style="
     position:absolute;
     left:-56%;
     bottom:50%;
     transform:translateY(50%);
     background:#6f8d7b;
     color:white;
     padding:6px 12px;
     border-radius:4px;
     font-size:13px;
     box-shadow:0 2px 6px rgba(0,0,0,0.25);
     display:none;
   ">
        </div>

        <button type="button" id="createFolderBtn">Create Folder</button>
        <span id="newFolderInputWrap" style="display:none;">
          <input type="text" id="newFolderName" placeholder="Folder name">
          <button type="button" id="newFolderOk">OK</button>
          <button type="button" id="newFolderCancel">Cancel</button>
        </span>
        <button type="button" id="clearSelectedFolders">Clear Selected</button>
        <button type="button" id="confirmFolderSelection">Done</button>
      </div>

    </div>
  </div>

  <script>
    $(document).on('mouseenter', '.flash-backup_betatip', function () {
      const $el = $(this);

      if (!$el.hasClass('tooltipstered')) {
        $el.tooltipster({
          maxWidth: 300,
          content: $el.data('tooltip')
        });
        $el.removeAttr('title');

        setTimeout(() => {
          if ($el.is(':hover')) {
            $el.tooltipster('open');
          }
        }, 500);
      }
    });

    document.getElementById('copy-last-run-log').addEventListener('click', () => {
      const toast = document.getElementById('logtoast');
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 2000);
    });

    function isValidWebhookUrl(url) {
      if (url.startsWith('https://discord.com/api/webhooks/')) return true;
      if (url.startsWith('https://hooks.slack.com/')) return true;
      if (url.startsWith('https://outlook.office.com/webhook')) return true;
      if (url.startsWith('https://api.pushover.net/')) return true;
      if (url.includes('ntfy.sh')) return true;
      if (url.includes('/ntfy/')) return true;
      if (url.includes('/message') && url.startsWith('https://')) return true;
      return false;
    }

    function validateDiscordWebhook() {
      const val = $('#discord_webhook_url').val().trim();
      const valid = val === '' || isValidWebhookUrl(val);
      $('#discord-webhook-error').toggle(!valid);
      togglePushoverUserKeyRow();
      return valid;
    }

    function togglePushoverUserKeyRow() {
      const val = $('#discord_webhook_url').val().trim();
      if (val.startsWith('https://api.pushover.net/')) {
        $('#pushover-user-key-row').show();
      } else {
        $('#pushover-user-key-row').hide();
        $('#pushover_user_key').val('');
      }
    }

    function togglePushoverUserKeyRowRemote() {
      const val = $('#discord_webhook_url_remote').val().trim();
      if (val.startsWith('https://api.pushover.net/')) {
        $('#pushover-user-key-row-remote').show();
      } else {
        $('#pushover-user-key-row-remote').hide();
        $('#pushover_user_key_remote').val('');
      }
    }

    // Show/hide webhook field based on NOTIFICATIONS
    function toggleDiscordWebhookRow() {
      if ($('#notifications').val() === 'yes') {
        $('#discord-webhook-row').show();
        togglePushoverUserKeyRow();
      } else {
        $('#discord-webhook-row').hide();
        $('#pushover-user-key-row').hide();
        $('#pushover_user_key').val('');
      }
    }

    function toggleDiscordWebhookRowRemote() {
      if ($('#notifications_remote').val() === 'yes') {
        $('#discord-webhook-row-remote').show();
        togglePushoverUserKeyRowRemote();
      } else {
        $('#discord-webhook-row-remote').hide();
        $('#pushover-user-key-row-remote').hide();
        $('#pushover_user_key_remote').val('');
      }
    }

    $('#notifications').on('change', toggleDiscordWebhookRow);
    toggleDiscordWebhookRow();

    $('#discord_webhook_url').on('input', function () {
      validateDiscordWebhook();
      togglePushoverUserKeyRow();
    });

    function validateDiscordWebhookRemote() {
      const val = $('#discord_webhook_url_remote').val().trim();
      const valid = val === '' || isValidWebhookUrl(val);
      $('#discord-webhook-error-remote').toggle(!valid);
      togglePushoverUserKeyRowRemote();
      return valid;
    }

    $('#notifications_remote').on('change', toggleDiscordWebhookRowRemote);
    toggleDiscordWebhookRowRemote();

    $('#discord_webhook_url_remote').on('input', function () {
      validateDiscordWebhookRemote();
      togglePushoverUserKeyRowRemote();
    });

    let scheduleUILocked = false;
    let rebuildToken = 0;

    function validateBackupPrereqs() {
      const dest = $('#backup_destination').val()?.trim();

      if (!dest) {
        alert("Please select a backup destination for the schedule");
        return false;
      }

      if (!validateDiscordWebhook()) {
        alert("Please enter a valid Discord webhook URL or leave it blank");
        return false;
      }

      const webhookVal = $('#discord_webhook_url').val().trim();
      if (webhookVal.startsWith('https://api.pushover.net/')) {
        if (!$('#pushover_user_key').val().trim()) {
          alert('Please enter your Pushover user key');
          return false;
        }
      }

      return true;
    }

    function lockScheduleUI() {
      scheduleUILocked = true;
      $(".schedule-action-btn").prop("disabled", true);
    }

    function unlockScheduleUI() {
      scheduleUILocked = false;
      $(".schedule-action-btn").prop("disabled", false);
    }

    function showFolderToast(msg) {
      const t = $('#folderToast');
      t.stop(true, true);        // cancel any fade timers
      t.text(msg).fadeIn(150);

      setTimeout(() => {
        t.fadeOut(400);
      }, 2000);
    }

    const remoteTypes = JSON.parse('<?= addslashes(json_encode($remoteTypes)) ?>');

    let scheduleUILockedremote = false;
    let rebuildTokenremote = 0;

    function updateB2BucketVisibility() {
      const selected = $('#rclone_config_remote_hidden').val() || [];
      const anyB2 = selected.some(r => remoteTypes[r] === 'b2' || remoteTypes[r] === 'crypt-b2');
      if (anyB2) {
        $('#b2_bucket_row').show();
      } else {
        $('#b2_bucket_row').hide();
        $('#b2_bucket_name').val('');
      }
    }

    function validateBackupPrereqsremote() {
      const cronExprRemote = $('#cron_expression_hidden_remote').val() || '';

      // --- Check that at least one rclone remote is selected ---
      const selectedRemotes = $('#rclone_config_remote_hidden').val() || [];
      if (!selectedRemotes.length) {
        alert('Please select at least one rclone config');
        return false;
      }

      // --- Validate Path In Config ---
      const remotePath = $('#remote_path_in_config').val().trim();

      if (remotePath !== '' && !remotePath.startsWith('/')) {
        alert('Path In Config must start with a "/" or be left blank to use default /Flash_Backups');
        return false;
      }

      if (remotePath !== '' && !remotePath.endsWith('/')) {
        alert('Path In Config must end with a "/" or be left blank to use default /Flash_Backups');
        return false;
      }

      // --- Validate allowed characters for each folder segment ---
      if (remotePath !== '') {
        const inner = remotePath.replace(/^\/+|\/+$/g, '');
        const parts = inner.split('/');

        const validName = /^[A-Za-z0-9._+\-@ ]+$/;

        for (const p of parts) {
          if (!validName.test(p)) {
            alert(
              'Invalid character detected in folder name: "' + p + '"\n\n' +
              'Allowed characters:\nletters, numbers, space, _ - . + @'
            );
            return false;
          }
        }
      }

      // --- Validate B2 Bucket Name if any B2 remote selected ---
      const anyB2 = selectedRemotes.some(r => remoteTypes[r] === 'b2' || remoteTypes[r] === 'crypt-b2');
      if (anyB2) {
        const b2Bucket = $('#b2_bucket_name').val().trim();
        if (!b2Bucket) {
          alert('B2 Bucketname is required when a Backblaze B2 config is selected');
          return false;
        }
        const validBucket = /^[A-Za-z0-9._\-]+$/;
        const b2BucketStripped = b2Bucket.replace(/\/+$/, '');
        if (!validBucket.test(b2BucketStripped)) {
          alert('Invalid B2 bucket name: "' + b2Bucket + '"\n\nAllowed characters:\nletters, numbers, - . _');
          return false;
        }
      }

      if (!validateDiscordWebhookRemote()) {
        alert("Please enter a valid Discord webhook URL or leave it blank");
        return false;
      }

      const webhookValRemote = $('#discord_webhook_url_remote').val().trim();
      if (webhookValRemote.startsWith('https://api.pushover.net/')) {
        if (!$('#pushover_user_key_remote').val().trim()) {
          alert('Please enter your Pushover user key');
          return false;
        }
      }

      return true;
    }

    function lockScheduleUIremote() {
      scheduleUILockedremote = true;
      $(".schedule-action-btn-remote").prop("disabled", true);
    }

    function unlockScheduleUIremote() {
      scheduleUILockedremote = false;
      $(".schedule-action-btn-remote").prop("disabled", false);
    }

    function showFolderToastremote(msg) {
      const t = $('#folderToastremote');
      t.stop(true, true);
      t.text(msg).fadeIn(150);

      setTimeout(() => {
        t.fadeOut(400);
      }, 2000);
    }

    function updateBackupStatus() {
      fetch('/plugins/flash-backup_beta/helpers/backup_status_check.php')
        .then(res => res.json())
        .then(data => {
          document.getElementById('status-text').textContent = data.status;
        })
        .catch(() => {
          document.getElementById('status-text').textContent = 'Local Backup Not Running';
        });
    }

    updateBackupStatus();
    setInterval(updateBackupStatus, 1000);

    function updateRestoreStatus() {
      fetch('/plugins/flash-backup_beta/helpers/remote_status_check.php')
        .then(res => res.json())
        .then(data => {
          document.getElementById('status-text-remote').textContent = data.status;
        })
        .catch(() => {
          document.getElementById('status-text-remote').textContent = 'Remote Backup Not Running';
        });
    }

    updateRestoreStatus();
    setInterval(updateRestoreStatus, 1000);

    // --- Scheduling Dropdown Toggle (LOCAL) ---
    (function waitForSchedulingToggle() {
      function initSchedulingToggle() {
        const cronModeSelect = document.getElementById('cron_mode');

        // Option rows
        const minutesOptions = document.getElementById('minutes-options');
        const hourlyOptions = document.getElementById('hourly-options');
        const dailyOptions = document.getElementById('daily-options');
        const weeklyOptions = document.getElementById('weekly-options');
        const monthlyOptions = document.getElementById('monthly-options');
        const customOptions = document.getElementById('custom-options');

        // Inputs
        const minutesFreq = document.getElementById('minutes_frequency');
        const hourlyFreq = document.getElementById('hourly_frequency');
        const dailyTime = document.getElementById('daily_time');
        const weeklyDay = document.getElementById('weekly_day');
        const weeklyTime = document.getElementById('weekly_time');
        const monthlyDay = document.getElementById('monthly_day');
        const monthlyTime = document.getElementById('monthly_time');
        const customCron = document.getElementById('custom_cron');

        if (!cronModeSelect) return false;

        // Toggle which sub-options are visible
        function toggleCronOptions(value) {
          minutesOptions.style.display = (value === 'minutes') ? 'block' : 'none';
          hourlyOptions.style.display = (value === 'hourly') ? 'block' : 'none';
          dailyOptions.style.display = (value === 'daily') ? 'block' : 'none';
          weeklyOptions.style.display = (value === 'weekly') ? 'block' : 'none';
          monthlyOptions.style.display = (value === 'monthly') ? 'block' : 'none';
          customOptions.style.display = (value === 'custom') ? 'block' : 'none';
          updateCronExpression();
        }

        // Build cron string from dropdowns
        function updateCronExpression() {
          let cronString = "";

          if (cronModeSelect.value === "minutes" && minutesFreq) {
            const freq = parseInt(minutesFreq.value, 10);
            cronString = `*/${freq} * * * *`;
          }
          else if (cronModeSelect.value === "hourly" && hourlyFreq) {
            const freq = parseInt(hourlyFreq.value, 10);
            cronString = `0 */${freq} * * *`;
          }
          else if (cronModeSelect.value === "daily" && dailyTime) {
            const [hour, minute] = dailyTime.value.split(":");
            cronString = `0 ${parseInt(hour, 10)} * * *`;
          }
          else if (cronModeSelect.value === "weekly" && weeklyDay && weeklyTime) {
            const [hour, minute] = weeklyTime.value.split(":");
            const dayMap = {
              Sunday: 0, Monday: 1, Tuesday: 2, Wednesday: 3,
              Thursday: 4, Friday: 5, Saturday: 6
            };
            cronString = `0 ${parseInt(hour, 10)} * * ${dayMap[weeklyDay.value]}`;
          }
          else if (cronModeSelect.value === "monthly" && monthlyDay && monthlyTime) {
            const [hour, minute] = monthlyTime.value.split(":");
            const day = parseInt(monthlyDay.value, 10);
            cronString = `0 ${parseInt(hour, 10)} ${day} * *`;
          }
          else if (cronModeSelect.value === "custom" && customCron) {
            cronString = customCron.value.trim();
          }

          // Store cron string in hidden input
          let hidden = document.getElementById("cron_expression_hidden");
          if (!hidden) {
            hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.id = "cron_expression_hidden";
            hidden.name = "CRON_EXPRESSION";
            cronModeSelect.closest(".form-pair").appendChild(hidden);
          }
          hidden.value = cronString;
        }

        // Initialize visibility
        toggleCronOptions(cronModeSelect.value);

        // Event listeners
        cronModeSelect.addEventListener('change', (e) => toggleCronOptions(e.target.value));
        minutesFreq?.addEventListener('change', updateCronExpression);
        hourlyFreq?.addEventListener('change', updateCronExpression);
        dailyTime?.addEventListener('change', updateCronExpression);
        weeklyDay?.addEventListener('change', updateCronExpression);
        weeklyTime?.addEventListener('change', updateCronExpression);
        monthlyDay?.addEventListener('change', updateCronExpression);
        monthlyTime?.addEventListener('change', updateCronExpression);
        customCron?.addEventListener('input', updateCronExpression);

        return true;
      }

      if (!initSchedulingToggle()) {
        const observer = new MutationObserver(() => {
          if (initSchedulingToggle()) observer.disconnect();
        });
        observer.observe(document.body, { childList: true, subtree: true });
      }
    })();

    // --- Scheduling Dropdown Toggle (REMOTE) ---
    (function waitForSchedulingToggleRemote() {
      function initSchedulingToggleRemote() {
        const cronModeSelect = document.getElementById('cron_mode_remote');

        // Option rows
        const minutesOptions = document.getElementById('minutes-options-remote');
        const hourlyOptions = document.getElementById('hourly-options-remote');
        const dailyOptions = document.getElementById('daily-options-remote');
        const weeklyOptions = document.getElementById('weekly-options-remote');
        const monthlyOptions = document.getElementById('monthly-options-remote');
        const customOptions = document.getElementById('custom-options-remote');

        // Inputs
        const minutesFreq = document.getElementById('minutes_frequency_remote');
        const hourlyFreq = document.getElementById('hourly_frequency_remote');
        const dailyTime = document.getElementById('daily_time_remote');
        const weeklyDay = document.getElementById('weekly_day_remote');
        const weeklyTime = document.getElementById('weekly_time_remote');
        const monthlyDay = document.getElementById('monthly_day_remote');
        const monthlyTime = document.getElementById('monthly_time_remote');
        const customCron = document.getElementById('custom_cron_remote');

        if (!cronModeSelect) return false;

        function toggleCronOptions(value) {
          minutesOptions.style.display = (value === 'minutes') ? 'block' : 'none';
          hourlyOptions.style.display = (value === 'hourly') ? 'block' : 'none';
          dailyOptions.style.display = (value === 'daily') ? 'block' : 'none';
          weeklyOptions.style.display = (value === 'weekly') ? 'block' : 'none';
          monthlyOptions.style.display = (value === 'monthly') ? 'block' : 'none';
          customOptions.style.display = (value === 'custom') ? 'block' : 'none';
          updateCronExpressionRemote();
        }

        function updateCronExpressionRemote() {
          let cronString = "";

          if (cronModeSelect.value === "minutes" && minutesFreq) {
            const freq = parseInt(minutesFreq.value, 10);
            cronString = `*/${freq} * * * *`;
          }
          else if (cronModeSelect.value === "hourly" && hourlyFreq) {
            const freq = parseInt(hourlyFreq.value, 10);
            cronString = `0 */${freq} * * *`;
          }
          else if (cronModeSelect.value === "daily" && dailyTime) {
            const [hour, minute] = dailyTime.value.split(":");
            cronString = `0 ${parseInt(hour, 10)} * * *`;
          }
          else if (cronModeSelect.value === "weekly" && weeklyDay && weeklyTime) {
            const [hour, minute] = weeklyTime.value.split(":");
            const dayMap = {
              Sunday: 0, Monday: 1, Tuesday: 2, Wednesday: 3,
              Thursday: 4, Friday: 5, Saturday: 6
            };
            cronString = `0 ${parseInt(hour, 10)} * * ${dayMap[weeklyDay.value]}`;
          }
          else if (cronModeSelect.value === "monthly" && monthlyDay && monthlyTime) {
            const [hour, minute] = monthlyTime.value.split(":");
            const day = parseInt(monthlyDay.value, 10);
            cronString = `0 ${parseInt(hour, 10)} ${day} * *`;
          }
          else if (cronModeSelect.value === "custom" && customCron) {
            cronString = customCron.value.trim();
          }

          let hidden = document.getElementById("cron_expression_hidden_remote");
          if (!hidden) {
            hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.id = "cron_expression_hidden_remote";
            hidden.name = "CRON_EXPRESSION_REMOTE";
            cronModeSelect.closest(".form-pair").appendChild(hidden);
          }
          hidden.value = cronString;
        }

        toggleCronOptions(cronModeSelect.value);

        cronModeSelect.addEventListener('change', (e) => toggleCronOptions(e.target.value));
        minutesFreq?.addEventListener('change', updateCronExpressionRemote);
        hourlyFreq?.addEventListener('change', updateCronExpressionRemote);
        dailyTime?.addEventListener('change', updateCronExpressionRemote);
        weeklyDay?.addEventListener('change', updateCronExpressionRemote);
        weeklyTime?.addEventListener('change', updateCronExpressionRemote);
        monthlyDay?.addEventListener('change', updateCronExpressionRemote);
        monthlyTime?.addEventListener('change', updateCronExpressionRemote);
        customCron?.addEventListener('input', updateCronExpressionRemote);

        return true;
      }

      if (!initSchedulingToggleRemote()) {
        const observer = new MutationObserver(() => {
          if (initSchedulingToggleRemote()) observer.disconnect();
        });
        observer.observe(document.body, { childList: true, subtree: true });
      }
    })();

    function loadLastRunLog() {
      fetch('/plugins/flash-backup_beta/helpers/fetch_last_run_log.php')
        .then(res => res.text())
        .then(data => { document.getElementById('last-run-log').textContent = data || 'Flash backup log not found'; })
        .catch(() => { document.getElementById('last-run-log').textContent = 'Error loading flash backup log'; });
    }
    loadLastRunLog();
    setInterval(loadLastRunLog, 1000);

    // === Clear Log Button ===
    const clearLastRunBtn = document.getElementById("clear-last-run-log");

    if (clearLastRunBtn) {
      clearLastRunBtn.addEventListener("click", function () {
        if (confirm("Are you sure you want to clear the flash backup Log?")) {
          fetch("/plugins/flash-backup_beta/helpers/clear_log.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRF-TOKEN": csrfToken
            },
            body: "log=last&csrf_token=" + encodeURIComponent(csrfToken)
          })
            .then(r => r.json())
            .then(data => {
              showToast(toastLast, data.message, data.ok ? "ok" : "err");
              if (data.ok) document.getElementById("last-run-log").textContent = "";
            })
            .catch(() => showToast(toastLast, "Failed to clear log", "err"));
        }
      });
    }

    $(document).ready(function () {
      const select = $('#backup_owner');
      const selected = select.data('selected') || 'nobody';

      $.getJSON('/plugins/flash-backup_beta/helpers/list_users_group100.php', function (data) {
        select.empty();

        data.users.forEach(user => {
          const opt = $('<option>', {
            value: user,
            text: user
          });

          if (user === selected) {
            opt.prop('selected', true);
          }

          select.append(opt);
        });
      });
    });

    // Force-close any Dynamix tooltip when dropdown opens
    function closeTooltips() {
      $('.flash-backup_betatip').trigger('mouseleave');
    }

    $('select').on('click', closeTooltips);
  </script>

  <script>
    // --- State ---
    let cronValid = false;
    let backupRunning = false;

    let cronValidRemote = false;
    let backupRunningRemote = false;

    // --- Elements (LOCAL) ---
    const cronInput = document.getElementById('custom_cron');
    const cronMode = document.getElementById('cron_mode');
    const backupbtn = document.getElementById('backupbtn');

    const warnFields = document.getElementById('cron-warning-fields');
    const warnSlash = document.getElementById('cron-warning-slash');

    // --- Elements (REMOTE) ---
    const cronInputRemote = document.getElementById('custom_cron_remote');
    const cronModeRemote = document.getElementById('cron_mode_remote');
    const backupbtnRemote = document.getElementById('backupbtn_remote');

    const warnFieldsRemote = document.getElementById('cron-warning-fields-remote');
    const warnSlashRemote = document.getElementById('cron-warning-slash-remote');

    // --- Unified button state controller (LOCAL) ---
    function updateBackupButtonState() {
      if (!backupbtn) return;
      backupbtn.disabled = !(cronValid && !backupRunning);
    }

    // --- Unified button state controller (REMOTE) ---
    function updateBackupButtonStateRemote() {
      if (!backupbtnRemote) return;
      backupbtnRemote.disabled = !(cronValidRemote && !backupRunningRemote);
    }

    // --- Live Cron Validator (LOCAL) ---
    function validateCronLive() {

      if (!cronMode || !cronInput) return;

      // If NOT in custom mode → cron is automatically valid
      if (cronMode.value !== "custom") {
        cronValid = true;

        [warnFields, warnSlash].forEach(w => { if (w) w.style.display = 'none'; });

        updateBackupButtonState();
        return;
      }

      const cronExpression = cronInput.value.trim();
      const cronParts = cronExpression.split(/\s+/);

      [warnFields, warnSlash].forEach(w => { if (w) w.style.display = 'none'; });

      cronValid = true;

      if (cronExpression === "") {
        cronValid = false;
        updateBackupButtonState();
        return;
      }

      if (cronParts.length !== 5) {
        cronValid = false;
        if (warnFields) warnFields.style.display = 'block';
      }

      if (cronParts.length === 5) {

        for (let i = 0; i < cronParts.length; i++) {
          const field = cronParts[i];

          if (!/^[\d*\/]+$/.test(field)) {
            cronValid = false;
            if (warnFields) warnFields.style.display = 'block';
          }

          if (field.includes('/')) {
            const validStep = field.match(/^\*\/\d+$/);
            if (!validStep) {
              cronValid = false;
              if (warnSlash) warnSlash.style.display = 'block';
            }
          }
        }
      }

      updateBackupButtonState();
    }

    // --- Live Cron Validator (REMOTE) ---
    function validateCronLiveRemote() {

      if (!cronModeRemote || !cronInputRemote) return;

      if (cronModeRemote.value !== "custom") {
        cronValidRemote = true;

        [warnFieldsRemote, warnSlashRemote].forEach(w => { if (w) w.style.display = 'none'; });

        updateBackupButtonStateRemote();
        return;
      }

      const cronExpression = cronInputRemote.value.trim();
      const cronParts = cronExpression.split(/\s+/);

      [warnFieldsRemote, warnSlashRemote].forEach(w => { if (w) w.style.display = 'none'; });

      cronValidRemote = true;

      if (cronExpression === "") {
        cronValidRemote = false;
        updateBackupButtonStateRemote();
        return;
      }

      if (cronParts.length !== 5) {
        cronValidRemote = false;
        if (warnFieldsRemote) warnFieldsRemote.style.display = 'block';
      }

      if (cronParts.length === 5) {

        for (let i = 0; i < cronParts.length; i++) {
          const field = cronParts[i];

          if (!/^[\d*\/]+$/.test(field)) {
            cronValidRemote = false;
            if (warnFieldsRemote) warnFieldsRemote.style.display = 'block';
          }

          if (field.includes('/')) {
            const validStep = field.match(/^\*\/\d+$/);
            if (!validStep) {
              cronValidRemote = false;
              if (warnSlashRemote) warnSlashRemote.style.display = 'block';
            }
          }
        }
      }

      updateBackupButtonStateRemote();
    }

    // --- Attach listeners ---
    if (cronInput) cronInput.addEventListener('input', validateCronLive);
    if (cronMode) cronMode.addEventListener('change', validateCronLive);
    validateCronLive();

    if (cronInputRemote) cronInputRemote.addEventListener('input', validateCronLiveRemote);
    if (cronModeRemote) cronModeRemote.addEventListener('change', validateCronLiveRemote);
    validateCronLiveRemote();

    let backupStartTime = 0;
    const MIN_DURATION = 5000;

    let backupStartTimeRemote = 0;
    const MIN_DURATION_REMOTE = 5000;

    function updateBackupUI(running) {
      const status = $('#backup-status');
      const btn = $('#backupbtn');

      if (running) {
        if (!backupStartTime) {
          backupStartTime = Date.now();
        }

        btn.text('Backup running...');
        status.show();

        return;
      }

      if (!backupStartTime) {
        btn.text('Backup Now');
        status.hide();
        return;
      }

      const elapsed = Date.now() - backupStartTime;

      if (elapsed < MIN_DURATION) {
        setTimeout(() => updateBackupUI(false), MIN_DURATION - elapsed);
        return;
      }

      backupStartTime = 0;
      btn.text('Backup Now');
      status.hide();
    }

    function updateBackupUIRemote(running) {
      const status = $('#backup-status-remote');
      const btn = $('#backupbtn_remote');

      if (running) {
        if (!backupStartTimeRemote) {
          backupStartTimeRemote = Date.now();
        }

        btn.text('Backup running...');
        status.show();

        return;
      }

      if (!backupStartTimeRemote) {
        btn.text('Backup Now');
        status.hide();
        return;
      }

      const elapsed = Date.now() - backupStartTimeRemote;

      if (elapsed < MIN_DURATION_REMOTE) {
        setTimeout(() => updateBackupUIRemote(false), MIN_DURATION_REMOTE - elapsed);
        return;
      }

      backupStartTimeRemote = 0;
      btn.text('Backup Now');
      status.hide();
    }

    function pollBackupStatus() {
      $.getJSON('/plugins/flash-backup_beta/helpers/backup_status.php', function (res) {
        backupRunning = res.running === true;
        updateBackupButtonState();
        updateBackupUI(res.running);
      });
    }

    function pollBackupStatusRemote() {
      $.getJSON('/plugins/flash-backup_beta/helpers/remote_status.php', function (res) {
        backupRunningRemote = res.running === true;
        updateBackupButtonStateRemote();
        updateBackupUIRemote(res.running);
      });
    }

    setInterval(pollBackupStatus, 1000);
    setInterval(pollBackupStatusRemote, 1000);

    $(document).ready(function () {
      pollBackupStatus();
      pollBackupStatusRemote();
    });

    // Force-close any Dynamix tooltip
    function closeTooltips() {
      $('.flash-backup_betatip').trigger('mouseleave');
    }

    // When your dropdown opens, close tooltips
    $('select').on('click', closeTooltips);

    let backupRequestInProgress = false;
    let backupRequestInProgressRemote = false;

    function backupclassifyPath(p) {
      if (p.startsWith('/mnt/user/')) return 'USER';
      if (p === '/mnt/user') return 'USER';
      if (p.startsWith('/mnt/user0/')) return 'USER0';
      if (p === '/mnt/user0') return 'USER0';
      return 'OTHER';
    }

    $('#backupbtn').on('click', async function () {

      if (backupRequestInProgress) {
        console.warn('Backup already being triggered');
        return;
      }

      const dest = $('#backup_destination').val().trim();

      if (!dest) {
        alert('Please select a backup destination');
        return;
      }

      if (!validateDiscordWebhook()) {
        alert("Please enter a valid Discord webhook URL or leave it blank");
        return;
      }

      const destClass = backupclassifyPath(dest);

      backupRequestInProgress = true;

      const cronExpr = $('#cron_expression_hidden').val() || '';

      const params = $.param({
        MINIMAL_BACKUP: $('#minimal_backup').is(':checked') ? 'yes' : 'no',
        BACKUP_DESTINATION: dest,
        BACKUPS_TO_KEEP: $('#backups_to_keep').val(),
        BACKUP_OWNER: $('#backup_owner').val(),
        DRY_RUN: $('#dry_run').val(),
        NOTIFICATIONS: $('#notifications').val(),
        DISCORD_WEBHOOK_URL: $('#discord_webhook_url').val().trim(),
        PUSHOVER_USER_KEY: $('#pushover_user_key').val().trim(),
        csrf_token: csrfToken
      });

      $.get('/plugins/flash-backup_beta/helpers/save_settings.php?' + params)
        .done(function (res) {

          if (res && res.status === 'ok') {
            startBackup();
          } else {
            alert('Failed to save settings');
          }

        })
        .fail(function () {
          alert('Error saving settings');
        })
        .always(function () {
          backupRequestInProgress = false;
        });

    });

    $('#b2_bucket_name').on('input', function () {
      let val = $(this).val();
      // Collapse multiple slashes
      val = val.replace(/\/+/g, '/');
      $(this).val(val);
      // Debounce trailing slash normalization (2 seconds)
      clearTimeout(b2BucketNameTimer);
      b2BucketNameTimer = setTimeout(() => {
        let v = $('#b2_bucket_name').val().trim();
        if (v !== '' && !v.endsWith('/')) {
          $('#b2_bucket_name').val(v + '/');
        }
      }, 2000);
    });
    // Final safety net on blur
    $('#b2_bucket_name').on('blur', function () {
      let val = $(this).val().trim().toLowerCase();
      if (val === '') return;
      val = val.replace(/\/+/g, '/');
      if (!val.endsWith('/')) val = val + '/';
      $(this).val(val);
    });
    $(function () {
      let val = $('#b2_bucket_name').val().trim();
      if (val === '') return;
      // Collapse multiple slashes
      val = val.replace(/\/+/g, '/');
      // Ensure trailing slash
      if (!val.endsWith('/')) {
        val = val + '/';
      }
      $('#b2_bucket_name').val(val);
    });

    $('#backupbtn_remote').on('click', async function () {

      if (backupRequestInProgressRemote) {
        console.warn('Remote backup already being triggered');
        return;
      }

      const cronExprRemote = $('#cron_expression_hidden_remote').val() || '';

      // --- Check that at least one rclone remote is selected ---
      const selectedRemotes = $('#rclone_config_remote_hidden').val() || [];
      if (!selectedRemotes.length) {
        alert('Please select at least one rclone config');
        return;
      }

      // --- Validate Path In Config ---
      const remotePath = $('#remote_path_in_config').val().trim();

      if (remotePath !== '' && !remotePath.startsWith('/')) {
        alert('Path In Config must start with a "/" or be left blank to use default /Flash_Backups');
        return;
      }

      if (remotePath !== '' && !remotePath.endsWith('/')) {
        alert('Path In Config must end with a "/" or be left blank to use default /Flash_Backups');
        return;
      }

      // --- Validate allowed characters for each folder segment ---
      if (remotePath !== '') {
        const inner = remotePath.replace(/^\/+|\/+$/g, ''); // strip leading/trailing slashes
        const parts = inner.split('/');

        // rclone-safe folder name characters
        const validName = /^[A-Za-z0-9._+\-@ ]+$/;

        for (const p of parts) {
          if (!validName.test(p)) {
            alert(
              'Invalid character detected in folder name: "' + p + '"\n\n' +
              'Allowed characters:\nletters, numbers, space, _ - . + @'
            );
            return;
          }
        }
      }

      // --- Validate B2 Bucket Name if any B2 remote selected ---
      const anyB2 = selectedRemotes.some(r => remoteTypes[r] === 'b2' || remoteTypes[r] === 'crypt-b2');
      if (anyB2) {
        const b2Bucket = $('#b2_bucket_name').val().trim();
        if (!b2Bucket) {
          alert('B2 Bucketname is required when a Backblaze B2 config is selected');
          return;
        }
        const validBucket = /^[A-Za-z0-9._\-]+$/;
        const b2BucketStripped = b2Bucket.replace(/\/+$/, '');
        if (!validBucket.test(b2BucketStripped)) {
          alert('Invalid B2 bucket name: "' + b2Bucket + '"\n\nAllowed characters:\nletters, numbers, - . _');
          return;
        }
      }

      if (!validateDiscordWebhookRemote()) {
        alert("Please enter a valid Discord webhook URL or leave it blank");
        return;
      }

      backupRequestInProgressRemote = true;
      let finalPath = remotePath === '' ? '/Flash_Backups/' : remotePath;
      const b2Bucket = $('#b2_bucket_name').val().trim();

      const params = $.param({
        MINIMAL_BACKUP_REMOTE: $('#minimal_backup_remote').is(':checked') ? 'yes' : 'no',
        RCLONE_CONFIG_REMOTE: selectedRemotes,
        REMOTE_PATH_IN_CONFIG: finalPath,
        B2_BUCKET_NAME: b2Bucket,
        BACKUPS_TO_KEEP_REMOTE: $('#backups_to_keep_remote').val(),
        DRY_RUN_REMOTE: $('#dry_run_remote').val(),
        NOTIFICATIONS_REMOTE: $('#notifications_remote').val(),
        DISCORD_WEBHOOK_URL_REMOTE: $('#discord_webhook_url_remote').val().trim(),
        PUSHOVER_USER_KEY_REMOTE: $('#pushover_user_key_remote').val().trim(),
        csrf_token: csrfToken
      });

      $.get('/plugins/flash-backup_beta/helpers/save_settings_remote.php?' + params)
        .done(function (res) {

          if (res && res.status === 'ok') {
            startBackupRemote();
          } else {
            alert('Failed to save remote settings');
          }

        })
        .fail(function () {
          alert('Error saving remote settings');
        })
        .always(function () {
          backupRequestInProgressRemote = false;
        });

    });

    function startBackup() {
      $.get('/plugins/flash-backup_beta/helpers/backup.php', {
        csrf_token: csrfToken
      })
        .done(function (res) {
          if (res && res.status === 'ok') {
            console.log('Backup started, PID:', res.pid);
          } else {
            alert(res.message || 'Failed to start backup');
          }
        })
        .fail(function () {
          alert('Error starting backup');
        });
    }

    function startBackupRemote() {
      $.get('/plugins/flash-backup_beta/helpers/remote_backup.php', {
        csrf_token: csrfToken
      })
        .done(function (res) {
          if (res && res.status === 'ok') {
            console.log('Remote backup started, PID:', res.pid);
          } else {
            alert(res.message || 'Failed to start remote backup');
          }
        })
        .fail(function () {
          alert('Error starting remote backup');
        });
    }

    function cronToMinutesOfWeek(expr) {
      // Returns array of [minuteOfWeek, ...] that a cron fires on
      // Handles: */N, hourly, daily, weekly, monthly (best-effort for conflict detection)
      const parts = expr.trim().split(/\s+/);
      if (parts.length !== 5) return [];

      const [min, hour, dom, month, dow] = parts;
      const minutes = [];

      const MINS_IN_WEEK = 7 * 24 * 60;

      // */N minutes
      const mInterval = min.match(/^\*\/(\d+)$/);
      if (mInterval && hour === '*' && dom === '*' && month === '*' && dow === '*') {
        const n = parseInt(mInterval[1], 10);
        for (let i = 0; i < MINS_IN_WEEK; i += n) minutes.push(i);
        return minutes;
      }

      // Hourly: 0 */N * * *
      const hInterval = hour.match(/^\*\/(\d+)$/);
      if (min === '0' && hInterval && dom === '*' && month === '*' && dow === '*') {
        const n = parseInt(hInterval[1], 10);
        for (let h = 0; h < 7 * 24; h += n) minutes.push(h * 60);
        return minutes;
      }

      // Daily: 0 H * * *
      if (min === '0' && /^\d+$/.test(hour) && dom === '*' && month === '*' && dow === '*') {
        const h = parseInt(hour, 10);
        for (let d = 0; d < 7; d++) minutes.push(d * 24 * 60 + h * 60);
        return minutes;
      }

      // Weekly: 0 H * * D
      if (min === '0' && /^\d+$/.test(hour) && dom === '*' && month === '*' && /^\d+$/.test(dow)) {
        const h = parseInt(hour, 10);
        const d = parseInt(dow, 10);
        minutes.push(d * 24 * 60 + h * 60);
        return minutes;
      }

      // Monthly: 0 H D * * — treat as weekly on day-of-month mod 7 (best effort)
      if (min === '0' && /^\d+$/.test(hour) && /^\d+$/.test(dom) && month === '*' && dow === '*') {
        const h = parseInt(hour, 10);
        const d = (parseInt(dom, 10) - 1) % 7;
        minutes.push(d * 24 * 60 + h * 60);
        return minutes;
      }

      return [];
    }

    function checkCronConflicts(newCron, existingCrons, excludeId, thresholdMinutes) {
      const newTimes = cronToMinutesOfWeek(newCron);
      if (!newTimes.length) return null;

      const MINS_IN_WEEK = 7 * 24 * 60;

      for (const entry of existingCrons) {
        if (entry.id === excludeId) continue;

        const existingTimes = cronToMinutesOfWeek(entry.cron);

        for (const nt of newTimes) {
          for (const et of existingTimes) {
            // Circular distance to handle week wrap-around
            const diff = Math.min(
              Math.abs(nt - et),
              MINS_IN_WEEK - Math.abs(nt - et)
            );
            if (diff < thresholdMinutes) {
              return entry.cron;
            }
          }
        }
      }

      return null;
    }

    async function fetchExistingCrons() {
      return $.getJSON('/plugins/flash-backup_beta/helpers/schedule_cron_check.php');
    }

    // --- Global variable to track editing ---
    window.editingScheduleId = null;

    // --- Load schedule list ---
    function loadSchedules() {
      return $.get(
        '/plugins/flash-backup_beta/helpers/schedule_list.php',
        function (html) {
          $('#schedule-list').html(html);
        }
      ).always(() => {
        unlockScheduleUI();
      });
    }

    // --- Build cron string from UI selections (LOCAL ONLY, unchanged) ---
    function validateCustomCron(expr) {
      expr = expr.trim();
      const parts = expr.split(/\s+/);
      if (parts.length !== 5) return { valid: false };
      if (parts[0] === '*') return { valid: false };
      const m = parts[0].match(/^\*\/(\d+)$/);
      if (m && parseInt(m[1], 10) < 2) return { valid: false };
      return { valid: true, expression: expr };
    }

    function buildCronFromUI() {
      const mode = $('#cron_mode').val();
      switch (mode) {
        case 'minutes': {
          const v = parseInt($('#minutes_frequency').val(), 10);
          return { valid: true, expression: `*/${v} * * * *` };
        }
        case 'hourly': {
          const v = parseInt($('#hourly_frequency').val(), 10);
          return { valid: true, expression: `0 */${v} * * *` };
        }
        case 'daily': {
          const h = parseInt($('#daily_time').val(), 10);
          const m = parseInt($('#daily_minute').val(), 10);
          return { valid: true, expression: `${m} ${h} * * *` };
        }
        case 'weekly': {
          const dayMap = { Sunday: 0, Monday: 1, Tuesday: 2, Wednesday: 3, Thursday: 4, Friday: 5, Saturday: 6 };
          const d = dayMap[$('#weekly_day').val()];
          const h = parseInt($('#weekly_time').val(), 10);
          const m = parseInt($('#weekly_minute').val(), 10);
          return { valid: true, expression: `${m} ${h} * * ${d}` };
        }
        case 'monthly': {
          const d = parseInt($('#monthly_day').val(), 10);
          const h = parseInt($('#monthly_time').val(), 10);
          const m = parseInt($('#monthly_minute').val(), 10);
          return { valid: true, expression: `${m} ${h} ${d} * *` };
        }
        case 'custom':
          return validateCustomCron($('#custom_cron').val());
        default:
          return { valid: false };
      }
    }

    // --- Create or update schedule ---
    async function scheduleJob(type) {

      if (!validateBackupPrereqs()) {
        return;
      }

      if (scheduleUILocked) return;
      lockScheduleUI();

      const cron = buildCronFromUI();
      if (!cron.valid) {
        unlockScheduleUI();
        alert("Invalid cron expression");
        return;
      }

      const existingCrons = await fetchExistingCrons();
      const conflict = checkCronConflicts(cron.expression, existingCrons, window.editingScheduleId, 15);
      if (conflict) {
        unlockScheduleUI();
        alert('This schedule is within 15 minutes of an existing schedule (' + conflict + '). Please choose a different time.');
        return;
      }

      // -------------------------------
      // CONTINUE WITH NORMAL SAVE LOGIC
      // -------------------------------

      const settings = {};
      $('input[name], select[name]').each(function () {
        if ($(this).is(':checkbox')) {
          settings[this.name] = $(this).is(':checked') ? 'yes' : 'no';
        } else {
          settings[this.name] = $(this).val();
        }
      });

      const url = window.editingScheduleId
        ? 'schedule_update.php'
        : 'schedule_create.php';

      $.ajax({
        type: 'POST',
        url: `/plugins/flash-backup_beta/helpers/${url}`,
        data: {
          id: window.editingScheduleId,
          type: type,
          cron: cron.expression,
          settings: settings
        },
        success: function (response) {
          resetScheduleUI();
          window.editingScheduleId = null;
          loadSchedules();
          showPopup("Schedule saved!");
        },
        error: function (xhr) {
          unlockScheduleUI();

          if (xhr.status === 409) {
            alert('Duplicate schedule detected during create!');
          } else {
            alert('Error creating/updating schedule: ' + xhr.responseText);
          }
        }
      });
    }

    // --- Edit a schedule ---
    function editSchedule(id) {
      if (scheduleUILocked) return;   // prevent double‑clicks during reload
      lockScheduleUI();               // freeze all schedule action buttons

      $.getJSON('/plugins/flash-backup_beta/helpers/schedule_load.php', { id }, function (s) {
        const settings = s.SETTINGS || {};

        // Apply schedule type first
        if (s.TYPE) {
          $('[name="type"]').val(s.TYPE).trigger('change');
        }

        // Apply all settings to form fields
        for (const k in settings) {
          const el = $('[name="' + k + '"]');
          if (!el.length) continue;

          if (el.is(':checkbox')) {
            const v = String(settings[k]).toLowerCase();
            el.prop('checked', v === 'yes' || v === '1' || v === 'true');
          } else if (el.is(':radio')) {
            $('[name="' + k + '"][value="' + settings[k] + '"]').prop('checked', true);
          } else {
            el.val(settings[k]).trigger('change');
          }
        }

        // Cron mode detection
        $('#cron_mode')
          .val(detectCronMode(s.CRON))
          .trigger('change');

        // Store ID globally
        window.editingScheduleId = id;

        // Switch Schedule It → Edit
        $('#schedule-local-backup').text('Update');
        const $tip = $('#schedule-local-backup').closest('span');
        $tip.data('tooltip', 'Update the local backup schedule using the settings shown in the fields above');
        if ($tip.hasClass('tooltipstered')) $tip.tooltipster('content', 'Update the local backup schedule using the settings shown in the fields above');

        // Show Cancel button
        $('#cancelEditBtn').show();

        unlockScheduleUI();
      });
    }

    $('#cancelEditBtn').on('click', function () {
      location.reload();
    });

    function showPopup(message) {
      const popup = $('#popupMessage');

      popup.text(message).fadeIn(150);

      setTimeout(() => {
        popup.fadeOut(200, () => {
          popup.text('');
          popup.hide();
        });
      }, 3000);
    }

    function resetScheduleUI() {
      // Revert Edit → Schedule It
      $('#schedule-local-backup').text('Schedule It');
      const $tip = $('#schedule-local-backup').closest('span');
      $tip.data('tooltip', 'Create a backup schedule using the settings shown in the fields above');
      if ($tip.hasClass('tooltipstered')) $tip.tooltipster('content', 'Create a backup schedule using the settings shown in the fields above');

      // Hide Cancel button
      $('#cancelEditBtn').hide();

      // Remove any popup message immediately
      $('#popupMessage').stop(true, true).hide().text('');
    }

    // --- Delete a schedule ---
    function deleteSchedule(id) {
      if (scheduleUILocked) return;   // prevent double‑clicks during reload

      if (!confirm("Delete this schedule?")) return;

      lockScheduleUI();               // freeze all schedule action buttons

      $.post(
        '/plugins/flash-backup_beta/helpers/schedule_delete.php',
        { id: id }
      ).always(() => {
        loadSchedules();
      });
    }

    // --- Run backup manually ---
    function runScheduleBackup(id, btn) {
      if (scheduleUILocked) return;

      if (!confirm("Are you sure you want to run this backup now?")) return;

      lockScheduleUI();

      // Disable clicked button and change tooltip
      btn.disabled = true;
      const originalText = btn.textContent;
      const originalTitle = btn.getAttribute('title');

      btn.textContent = "Running";

      $.post('/plugins/flash-backup_beta/helpers/run_schedule.php', { id })
        .done(function (res) {
          if (!res.started) {
            alert("Failed to start backup");
            btn.disabled = false;
            btn.textContent = originalText;
            btn.setAttribute('title', originalTitle);
            unlockScheduleUI();
            return;
          }

          // Poll lock
          const poll = setInterval(function () {
            $.getJSON('/plugins/flash-backup_beta/helpers/check_lock.php', function (res) {
              if (!res.locked) {
                clearInterval(poll);

                btn.disabled = false;
                btn.textContent = originalText;

                unlockScheduleUI();
              }
            });
          }, 1000);
        })
        .fail(function (xhr, status, err) {
          alert("Failed to start backup: " + (xhr.responseJSON?.error || err));
          btn.disabled = false;
          btn.textContent = originalText;
          btn.setAttribute('title', originalTitle);
          unlockScheduleUI();
        });
    }

    // --- Toggle enable/disable ---
    function toggleSchedule(id, isEnabled) {
      if (scheduleUILocked) return;   // prevent double‑clicks during reload

      const msg = isEnabled
        ? "Disable this schedule?"
        : "Enable this schedule?";

      if (!confirm(msg)) return;

      lockScheduleUI();               // freeze all schedule action buttons

      $.post(
        '/plugins/flash-backup_beta/helpers/schedule_toggle.php',
        { id: id }
      ).always(() => {
        loadSchedules();
      });
    }

    // --- Button click handlers ---
    $(document).ready(function () {
      loadSchedules();

      $(document).on('click', '#schedule-local-backup', function () { scheduleJob('local-backup'); });
    });

    // --- Global variable to track editing ---
    window.editingScheduleIdremote = null;

    // --- Load schedule list ---
    function loadSchedulesremote() {
      return $.get(
        '/plugins/flash-backup_beta/helpers/schedule_list_remote.php',
        function (html) {
          $('#schedule-list-remote').html(html);
        }
      ).always(() => {
        unlockScheduleUIremote();
      });
    }

    // --- Build cron string from UI selections ---
    function validateCustomCronremote(expr) {
      expr = expr.trim();
      const parts = expr.split(/\s+/);
      if (parts.length !== 5) return { valid: false };
      if (parts[0] === '*') return { valid: false };
      const m = parts[0].match(/^\*\/(\d+)$/);
      if (m && parseInt(m[1], 10) < 2) return { valid: false };
      return { valid: true, expression: expr };
    }

    function buildCronFromUIremote() {
      const mode = $('#cron_mode_remote').val();
      switch (mode) {
        case 'minutes': {
          const v = parseInt($('#minutes_frequency_remote').val(), 10);
          return { valid: true, expression: `*/${v} * * * *` };
        }
        case 'hourly': {
          const v = parseInt($('#hourly_frequency_remote').val(), 10);
          return { valid: true, expression: `0 */${v} * * *` };
        }
        case 'daily': {
          const h = parseInt($('#daily_time_remote').val(), 10);
          const m = parseInt($('#daily_minute_remote').val(), 10);
          return { valid: true, expression: `${m} ${h} * * *` };
        }
        case 'weekly': {
          const dayMap = { Sunday: 0, Monday: 1, Tuesday: 2, Wednesday: 3, Thursday: 4, Friday: 5, Saturday: 6 };
          const d = dayMap[$('#weekly_day_remote').val()];
          const h = parseInt($('#weekly_time_remote').val(), 10);
          const m = parseInt($('#weekly_minute_remote').val(), 10);
          return { valid: true, expression: `${m} ${h} * * ${d}` };
        }
        case 'monthly': {
          const d = parseInt($('#monthly_day_remote').val(), 10);
          const h = parseInt($('#monthly_time_remote').val(), 10);
          const m = parseInt($('#monthly_minute_remote').val(), 10);
          return { valid: true, expression: `${m} ${h} ${d} * *` };
        }
        case 'custom':
          return validateCustomCronremote($('#custom_cron_remote').val());
        default:
          return { valid: false };
      }
    }

    // --- Create or update schedule ---
    async function scheduleJobremote(type) {

      if (!validateBackupPrereqsremote()) {
        return;
      }

      if (scheduleUILockedremote) return;
      lockScheduleUIremote();

      const cron = buildCronFromUIremote();
      if (!cron.valid) {
        unlockScheduleUIremote();
        alert("Invalid cron expression");
        return;
      }

      const existingCrons = await fetchExistingCrons();
      const conflict = checkCronConflicts(cron.expression, existingCrons, window.editingScheduleIdremote, 15);
      if (conflict) {
        unlockScheduleUIremote();
        alert('This remote schedule is within 15 minutes of an existing schedule (' + conflict + '). Please choose a different time.');
        return;
      }

      const settings = {};
      $('input[name], select[name]').each(function () {
        const key = this.name.replace(/\[\]$/, '');
        if ($(this).is(':checkbox')) {
          settings[key] = $(this).is(':checked') ? 'yes' : 'no';
        } else {
          const val = $(this).val();
          settings[key] = Array.isArray(val) ? val.join(',') : val;
        }
      });

      const url = window.editingScheduleIdremote
        ? 'schedule_update_remote.php'
        : 'schedule_create_remote.php';

      $.ajax({
        type: 'POST',
        url: `/plugins/flash-backup_beta/helpers/${url}`,
        data: {
          id: window.editingScheduleIdremote,
          type: type,
          cron: cron.expression,
          settings: settings
        },
        success: function (response) {
          resetScheduleUIremote();
          window.editingScheduleIdremote = null;
          loadSchedulesremote();
          showPopupremote("Schedule saved!");
        },
        error: function (xhr) {
          unlockScheduleUIremote();

          if (xhr.status === 409) {
            alert('Duplicate remote schedule detected during create!');
          } else {
            alert('Error creating/updating remote schedule: ' + xhr.responseText);
          }
        }
      });
    }

    // --- Edit a schedule ---
    function editScheduleremote(id) {
      if (scheduleUILockedremote) return;
      lockScheduleUIremote();

      $.getJSON('/plugins/flash-backup_beta/helpers/schedule_load_remote.php', { id }, function (s) {
        const settings = s.SETTINGS || {};

        if (s.TYPE) {
          $('[name="type_remote"]').val(s.TYPE).trigger('change');
        }

        for (const k in settings) {
          const el = $('[name="' + k + '"]');
          if (!el.length) continue;

          if (el.is(':checkbox')) {
            const v = String(settings[k]).toLowerCase();
            el.prop('checked', v === 'yes' || v === '1' || v === 'true');
          } else if (el.is(':radio')) {
            $('[name="' + k + '"][value="' + settings[k] + '"]').prop('checked', true);
          } else {
            el.val(settings[k]).trigger('change');
          }
        }

        $('#cron_mode_remote')
          .val(detectCronMode(s.CRON))
          .trigger('change');

        window.editingScheduleIdremote = id;

        $('#schedule-remote-backup').text('Update');
        const $tip = $('#schedule-remote-backup').closest('span');
        $tip.data('tooltip', 'Update the remote backup schedule using the settings shown in the fields above');
        if ($tip.hasClass('tooltipstered')) $tip.tooltipster('content', 'Update the remote backup schedule using the settings shown in the fields above');

        $('#cancelEditBtnremote').show();

        unlockScheduleUIremote();
      });
    }

    $('#cancelEditBtnremote').on('click', function () {
      location.reload();
    });

    function showPopupremote(message) {
      const popup = $('#popupMessageremote');

      popup.text(message).fadeIn(150);

      setTimeout(() => {
        popup.fadeOut(200, () => {
          popup.text('');
          popup.hide();
        });
      }, 3000);
    }

    function resetScheduleUIremote() {
      $('#schedule-remote-backup').text('Schedule It');
      const $tip = $('#schedule-remote-backup').closest('span');
      $tip.data('tooltip', 'Create a remote backup schedule using the settings shown in the fields above');
      if ($tip.hasClass('tooltipstered')) $tip.tooltipster('content', 'Create a remote backup schedule using the settings shown in the fields above');
      $('#cancelEditBtnremote').hide();
      $('#popupMessageremote').stop(true, true).hide().text('');
    }

    // --- Delete a schedule ---
    function deleteScheduleremote(id) {
      if (scheduleUILockedremote) return;

      if (!confirm("Delete this remote schedule?")) return;

      lockScheduleUIremote();

      $.post(
        '/plugins/flash-backup_beta/helpers/schedule_delete_remote.php',
        { id: id }
      ).always(() => {
        loadSchedulesremote();
      });
    }

    // --- Run backup manually ---
    function runScheduleBackupremote(id, btn) {
      if (scheduleUILockedremote) return;

      if (!confirm("Are you sure you want to run this remote backup now?")) return;

      lockScheduleUIremote();

      btn.disabled = true;
      const originalText = btn.textContent;
      const originalTitle = btn.getAttribute('title');

      btn.textContent = "Running";

      $.post('/plugins/flash-backup_beta/helpers/run_schedule_remote.php', { id })
        .done(function (res) {
          if (!res.started) {
            alert("Failed to start remote backup");
            btn.disabled = false;
            btn.textContent = originalText;
            btn.setAttribute('title', originalTitle);
            unlockScheduleUIremote();
            return;
          }

          const poll = setInterval(function () {
            $.getJSON('/plugins/flash-backup_beta/helpers/check_lock.php', function (res) {
              if (!res.locked) {
                clearInterval(poll);
                btn.disabled = false;
                btn.textContent = originalText;
                unlockScheduleUIremote();
              }
            });
          }, 1000);
        })
        .fail(function (xhr, status, err) {
          alert("Failed to start remote backup: " + (xhr.responseJSON?.error || err));
          btn.disabled = false;
          btn.textContent = originalText;
          btn.setAttribute('title', originalTitle);
          unlockScheduleUIremote();
        });
    }

    // --- Toggle enable/disable ---
    function toggleScheduleremote(id, isEnabled) {
      if (scheduleUILockedremote) return;

      const msg = isEnabled
        ? "Disable this remote schedule?"
        : "Enable this remote schedule?";

      if (!confirm(msg)) return;

      lockScheduleUIremote();

      $.post(
        '/plugins/flash-backup_beta/helpers/schedule_toggle_remote.php',
        { id: id }
      ).always(() => {
        loadSchedulesremote();
      });
    }

    // --- Button click handlers ---
    $(document).ready(function () {
      loadSchedulesremote();

      $(document).on('click', '#schedule-remote-backup', function () { scheduleJobremote('remote-backup'); });
    });
  </script>

  <script>
    function showPopup(message) {
      const popup = $('#popupMessage');

      popup.text(message).fadeIn(150);

      setTimeout(() => {
        popup.fadeOut(200, () => {
          popup.text('');
          popup.hide();
        });
      }, 3000);
    }

    // --- Detect cron mode based on expression ---
    function detectCronMode(cron) {
      if (!cron) return 'minutes';
      if (/^\*\/\d+ \* \* \* \*$/.test(cron)) return 'minutes';
      if (/^0 \*\/\d+ \* \* \*$/.test(cron)) return 'hourly';
      if (/^\d+ \d+ \* \* \*$/.test(cron)) return 'daily';
      if (/^\d+ \d+ \* \* [0-6]$/.test(cron)) return 'weekly';
      if (/^\d+ \d+ \d+ \* \*$/.test(cron)) return 'monthly';
      return 'custom';
    }
  </script>

  <script>
    if (typeof caPluginUpdateCheck === "function") {
      caPluginUpdateCheck("flash-backup_beta.plg", { name: "flash-backup_beta" });
    }
  </script>

  <script>
    let currentPath = "/mnt";
    let selectedFolders = [];        // folders checked in current view
    let accumulatedFolders = [];     // folders added via "Add Selected"
    let persistentFolders = [];   // survives modal close

    function resolveAndApplyPath(selectedPath, targetInputId) {
      const params = new URLSearchParams({
        path: selectedPath,
        csrf_token: csrf_token
      });

      fetch('/plugins/flash-backup_beta/helpers/resolve_path.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
      })
        .then(r => r.text())
        .then(resolvedPath => {
          const $field = $('#' + targetInputId);

          // Deterministic: always write something
          $field.val(resolvedPath || selectedPath);

          // Trigger any listeners
          $field.trigger('input');
          $field.trigger('change');

          $('#folderPickerModal').hide();
        })
        .catch(() => {
          // Fallback: original path
          const $field = $('#' + targetInputId);
          $field.val(selectedPath);
          $field.trigger('change');
          $('#folderPickerModal').hide();
        });
    }

    function loadFolders(path) {

      $.getJSON('/plugins/flash-backup_beta/helpers/list_folders.php',
        {
          path: path,
          field: activeInputFieldId   // send which field is active
        },

        function (data) {

          currentPath = data.current;
          selectedFolder = null;

          /* -----------------------
             Build Breadcrumb
          ----------------------- */
          const parts = currentPath.split('/').filter(p => p !== '');
          let breadcrumbHTML = '';
          let buildPath = '';

          parts.forEach((part, index) => {
            buildPath += '/' + part;

            breadcrumbHTML += `
          <span class="breadcrumb-part"
                data-path="${buildPath}"
                style="cursor:pointer;">
            ${part}
          </span>
        `;

            if (index < parts.length - 1) {
              breadcrumbHTML += ' / ';
            }
          });

          $('#folderBreadcrumb').html(breadcrumbHTML);


          /* -----------------------
             Build Folder List
          ----------------------- */
          let html = '';

          // Up Directory (never above /mnt)
          if (data.parent) {
            html += `
          <div class="vm-folder-item browse-row"
               data-path="${data.parent}"
               style="cursor:pointer; display:flex; align-items:center;">
            .. Up Directory
          </div>
        `;
          }

          data.folders.forEach(folder => {

            const isChecked = persistentFolders.includes(folder.path) ? 'checked' : '';
            const disabledAttr = folder.selectable ? '' : 'disabled';
            const tooltip = folder.selectable ? '' : 'title="Can’t select. Browse deeper"';
            const disabledStyle = folder.selectable ? '' : 'style="opacity:0.4;"';

            html += `
  <div class="vm-folder-item browse-row"
       data-path="${folder.path}"
       style="display:flex; align-items:center; gap:0px;">

    <label class="folder-check-label" style="display:flex; align-items:center; cursor:pointer; padding:9px 2px 4px 4px;">
      <input type="checkbox"
             class="folder-checkbox"
             value="${folder.path}"
             ${isChecked}
             ${disabledAttr}
             ${tooltip}
             ${disabledStyle}>
    </label>

    <span class="folder-name-label" style="flex:1; cursor:pointer;">${folder.name}</span>
  </div>
`;
          });

          $('#folderList').html(html);

          /* -----------------------
             Breadcrumb Click
          ----------------------- */
          $('.breadcrumb-part').off('click').on('click', function () {
            const newPath = $(this).data('path');
            loadFolders(newPath);
          });

          /* -----------------------
             Browse Row Click
          ----------------------- */
          $('.browse-row').off('click').on('click', function (e) {
            if ($(e.target).closest('.folder-check-label').length) return;
            if ($(e.target).closest('.folder-name-label').length) return;
            const newPath = $(this).data('path');
            loadFolders(newPath);
          });

          $('.folder-name-label').off('click').on('click', function () {
            const newPath = $(this).closest('.browse-row').data('path');
            loadFolders(newPath);
          });

          $('.folder-check-label').off('click').on('click', function (e) {
            e.stopPropagation();
          });

          /* -----------------------
             Multi-Checkbox Selection
          ----------------------- */
          $('.folder-checkbox').off('change').on('change', function (e) {
            if (this.disabled) return;

            const path = $(this).val();

            if (this.checked) {
              if (!persistentFolders.includes(path)) {
                persistentFolders.push(path);
                showFolderToast("Folder selected");
              }
            } else {
              persistentFolders = persistentFolders.filter(p => p !== path);
              showFolderToast("Removed");
            }

            e.stopPropagation();
          });

          $('#addSelectedFolders').off('click').on('click', function () {

            selectedFolders.forEach(path => {
              if (!persistentFolders.includes(path)) {
                persistentFolders.push(path);
              }
            });

            selectedFolders = [];
            $('.folder-checkbox').prop('checked', false);

            showFolderToast("Added to selection");
          });

          $('#clearSelectedFolders').off('click').on('click', function () {
            persistentFolders = [];
            selectedFolders = [];
            accumulatedFolders = [];

            // Uncheck all boxes
            $('.folder-checkbox').prop('checked', false);

            showFolderToast("Selections cleared");
          });

        });
    }

    let activeInputFieldId = null;

    $('input[data-picker-title]').on('click', function () {
      activeInputFieldId = $(this).attr('id');
      const modalTitle = $(this).data('picker-title');

      // Load persistent selections from the input field
      const existing = $(this).val().trim();
      if (existing.length > 0) {
        persistentFolders = existing.split(',').map(s => s.trim());
      } else {
        persistentFolders = [];
      }

      // Reset session arrays
      selectedFolders = [];
      accumulatedFolders = [];

      $('#folderPickerTitle').text(modalTitle);
      $('#folderPickerModal').show();

      const savedPath = $(this).val();
      loadFolders(savedPath && savedPath.startsWith('/mnt') ? savedPath : '/mnt');
    });

    $('#closeFolderPicker').on('click', function () {
      $('#newFolderInputWrap').hide();
      $('#newFolderName').val('');
      $('#folderPickerModal').hide();
    });

$('#confirmFolderSelection').off('click').on('click', function (e) {
  e.preventDefault();

  if (!activeInputFieldId) return;

  const destString = persistentFolders.join(',');

  $('#' + activeInputFieldId).val(destString).trigger('change');

  $('#folderPickerModal').hide();
});

    $('#createFolderBtn').on('click', function () {
      $('#newFolderInputWrap').show();
      $('#newFolderName').val('').focus();
    });

    $('#newFolderCancel').on('click', function () {
      $('#newFolderInputWrap').hide();
      $('#newFolderName').val('');
    });

    $('#newFolderOk').on('click', function () {
      const name = $('#newFolderName').val().trim();
      if (!name) return;

      $.post('/plugins/flash-backup_beta/helpers/create_folder.php',
        { path: currentPath, name: name, csrf_token: csrf_token },
        function (res) {
          if (res.success) {
            $('#newFolderInputWrap').hide();
            $('#newFolderName').val('');
            loadFolders(currentPath);
          } else {
            alert(res.error || 'Failed to create folder');
          }
        }, 'json'
      );
    });

    let remotePathTimer = null;
    let b2BucketNameTimer;

    $('#remote_path_in_config').on('input', function () {
      let val = $(this).val();

      // Allow blank
      if (val.trim() === '') {
        clearTimeout(remotePathTimer);
        return;
      }

      // Collapse multiple slashes
      val = val.replace(/\/+/g, '/');

      // Ensure leading slash immediately
      if (!val.startsWith('/')) {
        val = '/' + val;
      }

      $(this).val(val);

      // Debounce trailing slash normalization (2 seconds)
      clearTimeout(remotePathTimer);
      remotePathTimer = setTimeout(() => {
        let v = $('#remote_path_in_config').val().trim();

        if (v !== '' && !v.endsWith('/')) {
          $('#remote_path_in_config').val(v + '/');
        }
      }, 2000);
    });

    // Final safety net on blur
    $('#remote_path_in_config').on('blur', function () {
      let val = $(this).val().trim();

      if (val === '') return;

      val = val.replace(/\/+/g, '/');

      if (!val.startsWith('/')) val = '/' + val;
      if (!val.endsWith('/')) val = val + '/';

      $(this).val(val);
    });

    $(function () {
      let val = $('#remote_path_in_config').val().trim();

      if (val === '') return;

      // Collapse multiple slashes
      val = val.replace(/\/+/g, '/');

      // Ensure leading slash
      if (!val.startsWith('/')) {
        val = '/' + val;
      }

      // Ensure trailing slash
      if (!val.endsWith('/')) {
        val = val + '/';
      }

      $('#remote_path_in_config').val(val);
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const multiselect = document.getElementById('rclone_config_remote');
      const hiddenSelect = document.getElementById('rclone_config_remote_hidden');
      const placeholder = multiselect.querySelector('.selected-placeholder');
      const optionsContainer = multiselect.querySelector('.options-container');
      const options = optionsContainer.querySelectorAll('.option');

      const selectAllBtn = optionsContainer.querySelector('.select-all');
      const clearAllBtn = optionsContainer.querySelector('.clear-all');

      function updatePlaceholder() {
        const selectedValues = [...hiddenSelect.options]
          .filter(o => o.selected)
          .map(o => o.value);

        placeholder.textContent = selectedValues.length
          ? selectedValues.join(', ')
          : 'Select config(s)';
      }

      /* Select all */
      selectAllBtn.addEventListener('click', (e) => {
        e.stopPropagation();

        options.forEach(opt => {
          opt.classList.add('selected');
          const val = opt.dataset.value;
          const hiddenOpt = [...hiddenSelect.options].find(o => o.value === val);
          if (hiddenOpt) hiddenOpt.selected = true;
        });

        updatePlaceholder();
        updateB2BucketVisibility();
      });

      /* Clear all */
      clearAllBtn.addEventListener('click', (e) => {
        e.stopPropagation();

        options.forEach(opt => opt.classList.remove('selected'));
        [...hiddenSelect.options].forEach(o => o.selected = false);

        updatePlaceholder();
        updateB2BucketVisibility();
      });

      multiselect.addEventListener('click', () => {
        optionsContainer.style.display = optionsContainer.style.display === 'block' ? 'none' : 'block';
      });

      document.addEventListener('click', (e) => {
        if (!multiselect.contains(e.target)) {
          optionsContainer.style.display = 'none';
        }
      });

      options.forEach(opt => {
        const value = opt.dataset.value;

        if ([...hiddenSelect.options].find(o => o.value === value && o.selected)) {
          opt.classList.add('selected');
        }

        opt.addEventListener('click', (e) => {
          e.stopPropagation();

          const hiddenOption = [...hiddenSelect.options].find(o => o.value === value);

          if (hiddenOption.selected) {
            hiddenOption.selected = false;
            opt.classList.remove('selected');
          } else {
            hiddenOption.selected = true;
            opt.classList.add('selected');
          }

          // Update placeholder
          const selectedValues = [...hiddenSelect.options].filter(o => o.selected).map(o => o.value);
          placeholder.textContent = selectedValues.length ? selectedValues.join(', ') : 'Select config(s)';

          // Optional: keep hiddenSelect values synced for AJAX
          hiddenSelect.dispatchEvent(new Event('change'));

          updateB2BucketVisibility();
        });
      });

      updateB2BucketVisibility();
    });
  </script>

  <script>
    function loadLastRunLog() {
      const logEl = document.getElementById('last-run-log');

      fetch('/plugins/flash-backup_beta/helpers/fetch_last_run_log.php')
        .then(resp => resp.text())
        .then(text => {
          logEl.textContent = text || 'Flash backup log not found';
        })
        .catch(err => {
          console.error('Failed to load log', err);
          logEl.textContent = 'Failed to load log';
        });
    }

    // Load log on page load
    document.addEventListener('DOMContentLoaded', loadLastRunLog);

    // Copy button logic
    document.getElementById('copy-last-run-log').addEventListener('click', function () {
      const logEl = document.getElementById('last-run-log');
      const text = logEl.innerText || logEl.textContent;

      if (!text || text.trim() === '' || text.includes('not found')) {
        alert('Flash backup log is empty or not loaded yet');
        return;
      }

      // Try Clipboard API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          showCopiedFeedback(this);
        }).catch(err => {
          console.warn('Clipboard API failed, using fallback', err);
          fallbackCopyText(text, this);
        });
      } else {
        fallbackCopyText(text, this);
      }
    });

    // Fallback for older browsers or Clipboard API failure
    function fallbackCopyText(text, btn) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        showCopiedFeedback(btn);
      } catch (err) {
        console.error('Fallback copy failed', err);
        alert('Failed to copy log');
      }
      document.body.removeChild(textarea);
    }

    // Visual feedback
    function showCopiedFeedback(btn) {
      const original = btn.textContent;
      btn.textContent = 'Copied!';
      btn.disabled = true;
      setTimeout(() => {
        btn.textContent = original;
        btn.disabled = false;
      }, 1200);
    }
  </script>

  <script>
    (function () {
      const CHECK_INTERVAL = 1000;

      function updateRunButtons(locked) {
        document.querySelectorAll('.run-schedule-btn').forEach(btn => {
          btn.disabled = locked;
          if (locked) {
            btn.classList.add('disabled');
          } else {
            btn.classList.remove('disabled');
          }
        });
      }

      async function pollLock() {
        try {
          const res = await fetch('/plugins/flash-backup_beta/helpers/check_lock.php');
          const data = await res.json();
          updateRunButtons(Boolean(data.locked));
        } catch (e) {
          console.error('Failed to check lock:', e);
        }
      }

      // Initial check
      pollLock();

      // Poll continuously
      setInterval(pollLock, CHECK_INTERVAL);
    })();

    function debounceButton(btn, delay = 500) {
      let cooling = false;
      btn.addEventListener('click', function () {
        if (cooling) return;
        cooling = true;
        setTimeout(() => cooling = false, delay);
      });
    }

    ['backupbtn', 'restorebtn', 'schedule-backup', 'cancelEditBtn', 'clear-last-run-log', 'copy-last-run-log', 'confirmFolderSelection', 'closeFolderPicker',
      // Flash Backup additions:
      'backupbtn_remote', 'schedule-local-backup', 'schedule-remote-backup', 'cancelEditBtnremote',
      'clearSelectedFolders'
    ].forEach(id => {
      const btn = document.getElementById(id);
      if (btn) debounceButton(btn);
    });
  </script>